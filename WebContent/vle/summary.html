<html>
<head>
<script type="text/javascript" src="util/scriptloader.js"></script>
<script type='text/javascript' src='yui/yui_3.0.0b1/build/yui/yui-min.js'></script>
<script type="text/javascript" src="sound/soundmanager/script/soundmanager2.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<script type='text/javascript'>
var projectsLoaded; //event variable
var pathsLoaded; //event variable
var summary_yui; //Used for YUI

var displayDivNames = ['displayFilenameDiv', 'displayTypeDiv', 'displayTitleDiv'];
var cfgXml;
var renderedSteps = false;

//initialize YUI
YUI().use('node', function(Y){summary_yui = Y});

/**
 * Creates events and launchs the parsing of projects and state when
 * the scripts for this page have finished loading.
 */
function afterScriptsLoad(){
	projectsLoaded = new YAHOO.util.CustomEvent("projectListLoaded");
	pathsLoaded = new YAHOO.util.CustomEvent("pathsLoaded");
	parseProjectsAndState();
};

/**
 * Loads scripts and provides callback for scriptloader
 */
function loaded(){
	scriptloader.initialize(document, afterScriptsLoad, 'main');
};

/**
 * Retrieves the configuration file and assigns the xml to cfgXml.
 * When completed, launches functions to either build or restore
 * the state and load projects.
 */
function parseProjectsAndState(){
	var callback = {
			success: function(o){
				if(o.responseXML){
				  cfgXml = o.responseXML;
				  
				  //check for IE 
				  if(window.ActiveXObject){
				  	var ieXML = new ActiveXObject("Microsoft.XMLDOM");
				  	ieXML.async = "false";
				  	ieXML.loadXML(o.responseText);
				  	cfgXml = ieXML;
				  };
				} else {
					cfgXml = loadXMLDocFromString(o.responseText);
				};

				if(cfgXml){
					restoreStateFromXml();
				} else {
					alert('summary.cfg.xml retrieved but unable to parse file, using default configuration.');
					setDefaultState();
				};
			},
			failure: function(o){
				console.warn('could not find summary.cfg.xml file, using default configuration.');
				setDefaultState();
			},
			scope: this
	};
	
	YAHOO.util.Connect.asyncRequest('GET', 'summary.cfg.xml', callback, null);
};

/**
 * Restores the state of summary.html from cfgXml
 */
function restoreStateFromXml(){
	//Restores state of nodeType checkboxes
	setChecked(cfgXml.getElementsByTagName('nodeTypes')[0].childNodes);

	//Restores state of display checkboxes
	setChecked(cfgXml.getElementsByTagName('display')[0].childNodes);

	//now retrieve Projects
	getProjects();
};

/**
 * Retrieves projects from cfgXml and runs function to load them.
 */
function getProjects(){
	var addToVisibleList = function(name) {
		var parent = document.getElementById("list1");
		var li = createElement(document, 'li', {"class":"list1"});
		var label = createElement(document, 'div', {id:"div_"+name, "class":"label"});
		var labelText = document.createTextNode('Project: ' + name);
		label.appendChild(labelText);
		var frame = createElement(document, 'iframe', {id:"ifrm_"+name, name:"ifrm_"+name, src:"/vlewrapper/vle/vle.html", width:"100%", height:"100%"});
		li.appendChild(label);
		li.appendChild(frame);
		parent.appendChild(li);
	};

	if(cfgXml){
		if(cfgXml.getElementsByTagName('rendered')[0].getAttribute('checked')=='true'){
			renderedSteps = true;
		};
		
		var pp = cfgXml.getElementsByTagName('path');
		for(var g=0;g<pp.length;g++){
			addToVisibleList(pp[g].firstChild.nodeValue);
		};
	} else {
		console.warn('could not find the configuration xml, unable to load projects');
	};
};

/**
 * Given a list of xml nodes, finds corresponding html
 * element and sets whether it is checked according to
 * the node attribute 'checked'.
 */
function setChecked(nodes){
	for(var p=0;p<nodes.length;p++){
		var box = document.getElementById(nodes[p].nodeName);
		if(box){
			if(nodes[p].getAttribute('checked')=='true'){
				box.checked = true;
			} else {
				box.checked = false;
			};
		};
	};
};

/**
 * Builds cfgXml from the defaults built into summary.html
 * and then loads the projects.
 */
function setDefaultState(){
	createCfgXmlFromState();
	getProjects();
};

	/**
	 * args[0] should contain the iframe name, like ifrm_2
	 */
function scriptsLoaded(args) {
	var contentUrl = "${contentUrl}";
	var contentBaseUrl = "${contentBaseUrl}";
	var userInfoUrl = "${userInfoUrl}";
	var getDataUrl = "${getDataUrl}";
	
	notificationManager.notify('scriptsloaded, args[0]:'+args[0],4);

	var windowName = args[0];
	var path = windowName.substring(5);
	if(path.indexOf('\\')!=-1){
		ifrm_currentProjectPath = path.substring(0, path.lastIndexOf('\\'));
		ifrm_currentProjectName = path.substring(path.lastIndexOf('\\') + 1, path.length);
		pathSeparator = '\\';
	} else {
		ifrm_currentProjectPath = path.substring(0, path.lastIndexOf('/'));
		ifrm_currentProjectName = path.substring(path.lastIndexOf('/') + 1, path.length);
		pathSeparator = '/';
	};
	
	window.frames[windowName].currentProjectPath = ifrm_currentProjectPath;
	window.frames[windowName].currentProjectName = ifrm_currentProjectName;
	window.frames[windowName].pathSeparator = pathSeparator;
	
	window.frames[windowName].renderAll(cfgXml);
};


/**
 * doMin = true iff minimize is requested. otherwise, maximize.
 */
function doMinimize(doMin) {
	var list = summary_yui.Node.all("#projectSummary ul li iframe");
	if (doMin) {
		list.each(function(v,k) {
			v.setStyle('display','none');
		});
	} else {
		list.each(function(v,k) {
			v.setStyle('display','block');
		});
	};
};

/**
 * If called with argument val=true, checks all nodeTypes
 * checkboxes, otherwise, unchecks all nodeTypes checkboxes
 * and calls filter function to update display.
 */
function selectAllFilter(val){
	var filters = document.getElementsByName('filterType');
	if(!val || val=='false'){ //remove checks for all filters
		for(var t=0;t<filters.length;t++){
			filters[t].checked = false;
		};
	} else { //add checks to all filters
		for(var t=0;t<filters.length;t++){
			filters[t].checked = true;
		};
	};

	filter();
};

/**
 * Determines which nodes the user has selected to show and shows those
 * items and hides the others.
 */
function filter(){
	var showNodes = [];
	var frms = window.frames;

	//get the nodetypes that have been checked
	getFiltered(showNodes);

	/**
	 * Cycles through the individual project frames then through each individual
	 * project's steps and sets style to 'block' (visible) if corresponding checkbox
	 * is checked or 'none' (not visible) otherwise.
	 */
	for(var q=1;q<frms.length;q++){//start at 1 to avoid 'hiddeniframe'
		var insideFrms = window.frames[frms[q].name].frames;
		for(var w=0;w<insideFrms.length;w++){
			if(insideFrms[w].name.indexOf('frame_')!=-1){
				var html = frms[q].document.getElementById(insideFrms[w].name).previousSibling.previousSibling.innerHTML;
				var type = html.substring(11, html.length);
				if(!showNodes.contains(type)){
					frms[q].document.getElementById(insideFrms[w].name + '_frameDiv').style.display = 'none';
				} else {
					frms[q].document.getElementById(insideFrms[w].name + '_frameDiv').style.display = 'block';
				};
			};
		};
	};

	adjustFrame();
};

/**
 * Takes an empty array and populates it with the nodeTypes that
 * the user has selected to 'show'.
 */
function getFiltered(show){
	var filters = document.getElementsByName('filterType');
	for(var e=0;e<filters.length;e++){
		if(filters[e].checked){
			show.push(filters[e].value);
		};
	};
};

/**
 * Updates the way the project Nodes are displayed based on
 * the state of the display filter options.
 */
function displayFilterChanged(){
	var showFilters = [];
	var frms = window.frames;

	getDisplayFiltered(showFilters);

	/**
	 * Cycles through the individual project frames then through each individual
	 * project's steps and sets style to 'block' (visible) if corresponding checkbox
	 * is checked or 'none' (not visible) otherwise.
	 */
	for(var q=1;q<frms.length;q++){//start at 1 to avoid 'hiddeniframe'
		var insideFrms = window.frames[frms[q].name].frames;
		for(var w=0;w<insideFrms.length;w++){
			if(insideFrms[w].name.indexOf('frame_')!=-1){
				if(showFilters.contains(displayDivNames[0])){//filename is checked
					frms[q].document.getElementById(insideFrms[w].name + '_' + displayDivNames[0]).style.display = 'block';
				} else {
					frms[q].document.getElementById(insideFrms[w].name + '_' + displayDivNames[0]).style.display = 'none';
				};
	
				if(showFilters.contains(displayDivNames[1])){//type is checked
					frms[q].document.getElementById(insideFrms[w].name + '_' + displayDivNames[1]).style.display = 'block';
				} else {
					frms[q].document.getElementById(insideFrms[w].name + '_' + displayDivNames[1]).style.display = 'none';
				};
	
				if(showFilters.contains(displayDivNames[2])){//title is checked
					frms[q].document.getElementById(insideFrms[w].name + '_' + displayDivNames[2]).style.display = 'block';
				} else {
					frms[q].document.getElementById(insideFrms[w].name + '_' + displayDivNames[2]).style.display = 'none';
				};
	
				if(showFilters.contains('rendered')){//render is checked
					if(!renderedSteps){
						var node = insideFrms[w].frameNode;
						node.render(frms[q].document.getElementById(insideFrms[w].name));
					};
					frms[q].document.getElementById(insideFrms[w].name).style.display =  'block';
				} else {
					frms[q].document.getElementById(insideFrms[w].name).style.display = 'none';
				};
			};
		};
	};

	if(document.getElementById('rendered').checked){
		renderedSteps = true;
	};

	adjustFrame();
};

/**
 * Takes an empty array and populates it with the display options that
 * the user has selected to 'show'.
 */
function getDisplayFiltered(show){
	var filters = document.getElementsByName('displayFilter');
	for(var y=0;y<filters.length;y++){
		if(filters[y].checked){
			show.push(filters[y].value);
		};
	};
};

/**
 * Saves the current state of user preferences.
 */
function saveConfig(){
	createCfgXmlFromState();
	var path = cfgXml.getElementsByTagName('configPath')[0].firstChild.nodeValue;
	var data;

	if(window.ActiveXObject) {
		data = cfgXml.xml;
	} else {
		data = (new XMLSerializer()).serializeToString(cfgXml);
	};
	
	if(path){
		var callback = {
				success: function(o){
					alert('configuration saved');
				},
				failure: function(o){
					console.warn('failed save of configuration');
				},
				scope: this
		}
		
		YAHOO.util.Connect.asyncRequest('POST', 'filemanager.html', callback, 'command=updateFile&param1=' + path + '&param2=summary.cfg.xml&param3=' + data);
	} else {
		alert('No configuration path set in xml, cannot save changes.');
	};
};

/**
 * If cfgXml does not exist, creates it and updates the attributes of
 * the nodes with the values of the associated elements within this page.
 */
function createCfgXmlFromState(){
	if(!cfgXml){
		var cfgStr = '<summary>\n<state><nodeTypes><BlueJNode checked="true"/><BrainstormNode checked="true"/>\n<FillinNode checked="false"/>\n<FlashNode checked="true"/>\n<HtmlNode checked="true"/>\n<MatchSequenceNode checked="false"/>\n<MultipleChoiceNode checked="true"/>\n<NoteNode checked="true"/>\n<OpenResponseNode checked="false"/>\n<OutsideUrlNode checked="true"/>\n</nodeTypes>\n<display>\n<displayFilenameDiv checked="false"/>\n<displayTypeDiv checked="true"/>\n<displayTitleDiv checked="false"/>\n<rendered checked="true"/>\n</display>\n<minimized checked="false"/>\n</state>\n<orderedProjects/>\n</summary>';
		cfgXml = loadXMLString(cfgStr);
	};

	var filters = document.getElementsByName('filterType');
	for(var d=0;d<filters.length;d++){
		updateXmlValue(cfgXml, filters[d]);
	};
	
	var displays = document.getElementsByName('displayFilter');
	for(var f=0;f<displays.length;f++){
		updateXmlValue(cfgXml, displays[f]);
	};
};

/**
 * Given an xml document and a html element, updates the associated
 * node in the xml document with the value of 'checked' in the html
 * element.
 */
function updateXmlValue(cfgXml, el){
	var xml = cfgXml.getElementsByTagName(el.id);
	if(xml[0]){
		xml[0].setAttribute('checked', el.checked);
	} else {
		console.warn('could not find element: ' + el.id + ' in cfg file.');
	};
};



// adjust height of iframe. If nav bar is visible, set iframe height=navbarheight.
// else, leave it untouched
function adjustFrame(){
	var frms = window.frames;
	for(var h=1;h<frms.length;h++){
		var totalHeight = 0;
		var children = window.frames[frms[h].name].document.body.childNodes;
		for(var j=0;j<children.length;j++){
			if(children[j].offsetHeight && children[j].offsetHeight>0){
				totalHeight += children[j].offsetHeight;
			};
		};
		document.getElementById(frms[h].name).style.height = totalHeight;
	};
	
};
</script>

</head>

<body class="yui-skin-sam" onload='loaded()'>

<div id="centeredDiv">

<div id="selectprojectlist">
<form method='POST' action='filemanager.html' id='projectlist'>
</form>
</div>

<div id="projectframesDiv">
</div>
<input type="button" value="Minimize All" onclick="doMinimize(true);"/>
<input type="button" value="Maximize All" onclick="doMinimize(false);"/>
<div id='filterDiv'>
	Select Nodes to Show:</br>
	<input type='checkbox' id='BlueJNode' value='BlueJNode' name='filterType' onclick='filter()' CHECKED>BlueJ</input>
	<input type='checkbox' id='BrainstormNode' value='BrainstormNode' name='filterType' onclick='filter()' CHECKED>Brainstorm</input>
	<input type='checkbox' id='FillinNode' value='FillinNode' name='filterType' onclick='filter()' CHECKED>Fillin</input>
	<input type='checkbox' id='FlashNode' value='FlashNode' name='filterType' onclick='filter()' CHECKED>Flash</input>
	<input type='checkbox' id='HtmlNode' value='HtmlNode' name='filterType' onclick='filter()' CHECKED>Html</input>
	<input type='checkbox' id='MatchSequenceNode' value='MatchSequenceNode' name='filterType' onclick='filter()' CHECKED>MatchSequence</input>
	<input type='checkbox' id='MultipleChoiceNode' value='MultipleChoiceNode' name='filterType' onclick='filter()' CHECKED>MultipleChoice</input>
	<input type='checkbox' id='NoteNode' value='NoteNode' name='filterType' onclick='filter()' CHECKED>Note</input>
	<input type='checkbox' id='OpenResponseNode' value='OpenResponseNode' name='filterType' onclick='filter()' CHECKED>OpenResponse</input>
	<input type='checkbox' id='OutsideUrlNode' value='OutsideUrlNode' name='filterType' onclick='filter()' CHECKED>OutsideUrl</input>
	<input type='button' value='Select All' onclick='selectAllFilter(true)'/>
	<input type='button' value='Deselect All' onclick='selectAllFilter(false)'/>
</div>
</br>

<div id='displayFilterDiv'>
	Select Options for displaying each Node:</br>
	<input type='checkbox' name='displayFilter' id='displayTitleDiv' value='displayTitleDiv' onclick='displayFilterChanged()'>Node Title</input>
	<input type='checkbox' name='displayFilter' id='displayFilenameDiv' value='displayFilenameDiv' onclick='displayFilterChanged()'>Node ID</input>
	<input type='checkbox' name='displayFilter' id='displayTypeDiv' value='displayTypeDiv' onclick='displayFilterChanged()'>Node Type</input>
	<input type='checkbox' name='displayFilter' id='rendered' value='rendered' onclick='displayFilterChanged()' CHECKED>Rendered</input>
</div>
</br>

<div id='saveConfig'>
	<input type='button' value='Save Configuration' onclick='saveConfig()'/>
</div>
<div id='adjustFrame'>
	<input type='button' value='Adjust Frames' onclick='adjustFrame()'/>
</div>
</br>

<div id='projectSummary'>
	<ul id='list1'></ul>
</div>

<div id='loading'>
	<div class='hd'></div>
	<div class='bd'></div>
	<div class='ft'></div>
</div>

<iframe id="hiddenifrm" name="hiddenifrm" scrolling="auto" frameborder="0" width="0%" height="0%"> [Content for
browsers that don't support iframes goes here.] </iframe></div>
<!-- centerDiv -->
</body>

</html>