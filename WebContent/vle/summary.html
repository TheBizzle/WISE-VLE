<html>
<head>
<script type="text/javascript" src="util/scriptloader.js"></script>
<script type='text/javascript' src='yui/yui_3.0.0b1/build/yui/yui-min.js'></script>
<script type="text/javascript" src="sound/soundmanager/script/soundmanager2.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<script type='text/javascript'>
var summary_yui;  // YUI global object for this page
var project;
var easyMode = true; //the mode that gets passed to the individual authoring pages
var currentProjectName;
var currentProjectPath;
var pathSeparator;
var projectSaved = true;
var projectsLoaded;
var pathsLoaded;

var projectPaths; //a | delimited string of the project paths specified in settings.xml
var hostedProjectPaths;
var hostedPaths = [];
var hostedURLs = [];
var hostedProject = false;
var hostedContentBaseURL;
var hostedContentURL;
var primaryPath = ""; //the default path to create new projects

function afterScriptsLoad(){
	projectsLoaded = new YAHOO.util.CustomEvent("projectListLoaded");
	pathsLoaded = new YAHOO.util.CustomEvent("pathsLoaded");
	getProjectPaths();
};

function loaded(){
	scriptloader.initialize(document, afterScriptsLoad, 'main');
};

function getProjectPaths(){
	var settings;
	var callback = {
		success: function(o){
			if(o.responseXML){
			  settings = o.responseXML;
			  
			  /***						***|
			   * Extra work needed for IE *|
			   ***						***/
			  if(window.ActiveXObject){
			  	var ieXML = new ActiveXObject("Microsoft.XMLDOM");
			  	ieXML.async = "false";
			  	ieXML.loadXML(o.responseText);
			  	settings = ieXML;
			  };
			  /***						***|
			   * End extra work for IE	  *|
			   ***						***/
			} else {
				settings = loadXMLDocFromString(o.responseText);
			};
			
			if(settings){
				var path = settings.getElementsByTagName('projectPaths');
				projectPaths = "";
				hostedProjectPaths = "";
				
				if(path && path[0] && path[0].firstChild){
					var hosted = path[0].getElementsByTagName('hosted');
					for(var i=0;i<hosted.length;i++){
						if(hosted[i] && hosted[i].firstChild){
							hostedProjectPaths += hosted[i].firstChild.nodeValue;
							if(i!=hosted.length-1){
								hostedProjectPaths += '~';
							};
						};
					};
				
					var paths = path[0].getElementsByTagName('path');
					for(var u=0;u<paths.length;u++){
						if(paths[u] && paths[u].firstChild){
							projectPaths += paths[u].firstChild.nodeValue;
							if(u!=paths.length-1){
								projectPaths += '~';
							};
						};
					};
					
					var primary = settings.getElementsByTagName('primaryPath');
					if(primary && primary[0] && primary[0].firstChild){
						primaryPath = primary[0].getElementsByTagName('path');
						if(primaryPath && primaryPath[0] && primaryPath[0].firstChild){
							primaryPath = primaryPath[0].firstChild.nodeValue;
							projectPaths += '~' + primaryPath;
						} else {
							primaryPath = "";
						};
					} else {
						primaryPath = "";
					};
				};
				
				pathsLoaded.fire();
				getProjects();
			} else {
				notificationManager.notify("Error retrieving settings", 3);
			};
		},
		failure: function(o){},
		scope: this
	};
	
	YAHOO.util.Connect.asyncRequest('GET', 'settings.xml', callback, null);
};


	/**
	 * args[0] should contain the iframe name, like ifrm_2
	 */
function scriptsLoaded(args) {
	var contentUrl = "${contentUrl}";
	var contentBaseUrl = "${contentBaseUrl}";
	var userInfoUrl = "${userInfoUrl}";
	var getDataUrl = "${getDataUrl}";
	
	notificationManager.notify('scriptsloaded, args[0]:'+args[0],4);

	var windowName = args[0];
	var path = windowName.substring(5);
	if(path.indexOf('\\')!=-1){
		ifrm_currentProjectPath = path.substring(0, path.lastIndexOf('\\'));
		ifrm_currentProjectName = path.substring(path.lastIndexOf('\\') + 1, path.length);
		pathSeparator = '\\';
	} else {
		ifrm_currentProjectPath = path.substring(0, path.lastIndexOf('/'));
		ifrm_currentProjectName = path.substring(path.lastIndexOf('/') + 1, path.length);
		pathSeparator = '/';
	};
	
	window.frames[windowName].currentProjectPath = ifrm_currentProjectPath;
	window.frames[windowName].currentProjectName = ifrm_currentProjectName;
	window.frames[windowName].pathSeparator = pathSeparator;
	
	window.frames[windowName].renderAll();
};


function applyDD(){
	YUI({combine: true, timeout: 10000}).use('dd-constrain', 'dd-proxy', 'dd-drop', function(Y) {
		summary_yui = Y;
	    //Listen for all drop:over events
	    Y.DD.DDM.on('drop:over', function(e) {
	        //Get a reference to out drag and drop nodes
	        var drag = e.drag.get('node'),
	            drop = e.drop.get('node');
	        
	        //Are we dropping on a li node?
	        if (drop.get('tagName').toLowerCase() === 'li') {
	            //Are we not going up?
	            if (!goingUp) {
	                drop = drop.get('nextSibling');
	            }
	            //Add the node to this list
	            e.drop.get('node').get('parentNode').insertBefore(drag, drop);
	            //Resize this nodes shim, so we can drop on it later.
	            e.drop.sizeShim();
	        }
	    });
	    //Listen for all drag:drag events
	    Y.DD.DDM.on('drag:drag', function(e) {
	        //Get the last y point
	        var y = e.target.lastXY[1];
	        //is it greater than the lastY var?
	        if (y < lastY) {
	            //We are going up
	            goingUp = true;
	        } else {
	            //We are going down..
	            goingUp = false;
	        }
	        //Cache for next check
	        lastY = y;
	    });
	    //Listen for all drag:start events
	    Y.DD.DDM.on('drag:start', function(e) {
	        //Get our drag object
	        var drag = e.target;
	        //Set some styles here
	        drag.get('node').setStyle('opacity', '.25');
	        drag.get('dragNode').set('innerHTML', drag.get('node').get('innerHTML'));
	        drag.get('dragNode').setStyles({
	            opacity: '.5',
	            borderColor: drag.get('node').getStyle('borderColor'),
	            backgroundColor: drag.get('node').getStyle('backgroundColor')
	        });
	    });
	    //Listen for a drag:end events
	    Y.DD.DDM.on('drag:end', function(e) {
	        var drag = e.target;
	        //Put out styles back
	        drag.get('node').setStyles({
	            visibility: '',
	            opacity: '1'
	        });
	    });
	    //Listen for all drag:drophit events
	    Y.DD.DDM.on('drag:drophit', function(e) {
	        var drop = e.drop.get('node'),
	            drag = e.drag.get('node');

	        //if we are not on an li, we must have been dropped on a ul
	        if (drop.get('tagName').toLowerCase() !== 'li') {
	            if (!drop.contains(drag)) {
	                drop.appendChild(drag);
	                onChanged(drop, drag);
	            } else {
	                onSort(drop, drag);
	            }
	        }
	    });

	    var onChanged = function(drop, drag) {
	        alert("onchange: drop:" + drop + ", drag:" + drag);
	    };

	    var onSort = function(drop, drag){
	        alert("onsort: drop:" + drop + ", drag:" + drag);
	    };
	    
	    //Static Vars
	    var goingUp = false, lastY = 0;

	    //Get the list of li's in the lists and make them draggable
	    var lis = Y.Node.all('#play ul li');
	    lis.each(function(v, k) {
	        var dd = new Y.DD.Drag({
	            node: v,
	            target: {
	                padding: '0 0 0 20'
	            }
	        }).plug(Y.Plugin.DDProxy, {
	            moveOnEnd: false
	        }).plug(Y.Plugin.DDConstrained, {
	            constrain2node: '#play'
	        });
	    });

	    //Create simple targets for the 2 lists..
	    var uls = Y.Node.all('#play ul');
	    uls.each(function(v, k) {
	        var tar = new Y.DD.Drop({
	            node: v
	        });
	    });
	    
	});
};


	

function getProjects() {

	// adds the project to the list of select-able projects in the projectlist checkbox group.
	var addOption = function(name){
		var parent = document.getElementById('projectlist');
		var option = createElement(document, 'input', {checked:true, type: 'checkbox', name: 'projectOption', id:"checkbox_"+name, value:name, onclick:"projectSelected('"+name+"')"});
		option.innerHTML = name;
		parent.appendChild(option);
		var projectText = document.createTextNode(name);
		parent.appendChild(projectText);
		parent.appendChild(createElement(document, 'br', {}));
	};

	var createframe = function(name) {
		var parent = document.getElementById("projectframesDiv");
		var frame = createElement(document, 'iframe', {id:"ifrm_"+name, name:"ifrm_"+name, src:"/vlewrapper/vle/vle.html", width:"100%", height:"100%"});
		parent.appendChild(frame);
		parent.appendChild(createElement(document, 'br', {}));
	};

	var addToVisibleList = function(name) {
		var parent = document.getElementById("list1");
		var li = createElement(document, 'li', {"class":"list1"});
		var label = createElement(document, 'div', {id:"ifrm_"+name, "class":"label"});
		var labelText = document.createTextNode(name);
		label.appendChild(labelText);
		var frame = createElement(document, 'iframe', {id:"ifrm_"+name, name:"ifrm_"+name, src:"/vlewrapper/vle/vle.html", width:"100%", height:"100%"});
		li.appendChild(label);
		li.appendChild(frame);
		parent.appendChild(li);
	};
	
	var handleCancel = function(){
		this.cancel();
	};

	var handleSubmit = function(){
		optionSelected();
	};
	
	var callback = {
		success:function(o){
			// clear existing list and frames
			var parent = document.getElementById('projectlist');
			while(parent.firstChild){
				parent.removeChild(parent.firstChild);
			};
			var parentDiv = document.getElementById('projectframesDiv');
			while(parentDiv.firstChild){
				parentDiv.removeChild(parentDiv.firstChild);
			};
						
			var projects = o.responseText.split('|');
			for(var a=0;a<projects.length;a++){
				//addOption(projects[a]);
				//createframe(projects[a]);
				addToVisibleList(projects[a]);
			};

			if(hostedProjectPaths!=null && hostedProjectPaths!=""){
				getHostedProjects(addOption);
			} else {
				projectsLoaded.fire();
			};
			applyDD();  // now apply DD functionality to the newly created elements
		},
		failure:function(o){notificationManager.notify('unable to retrieve projects from server', 3);},
		scope:this
	};
	
	YAHOO.util.Connect.asyncRequest('POST', 'filemanager.html', callback, "command=projectList&projectPaths=" + projectPaths);	
};

function getHostedProjects(addOption){
	hostedPaths = [];
	hostedURLs = [];
	var callback = {
		success: function(o){
			var hosted = o.responseText.split('|');
			for(var b=0;b<hosted.length;b++){
				var pathUrl = hosted[b].split('~');
				hostedPaths.push(pathUrl[0]);
				hostedURLs.push(pathUrl[1]);	
				addOption(pathUrl[1]);
			};
			projectsLoaded.fire();
		},
		failure: function(o){notificationManager.notify('unable to retrieve hosted projects from server', 3);},
		scope:this
	};
	
	YAHOO.util.Connect.asyncRequest('POST', 'filemanager.html', callback, "command=hostedProjectList&hostedProjectPaths=" + hostedProjectPaths);
};

/**
 * doMin = true iff minimize is requested. otherwise, maximize.
 */
function doMinimize(doMin) {
	if (doMin) {
		//alert('minimize' + summary_yui);
		var list = summary_yui.Node.all("#play ul li iframe");
		list.each(function(v,k) {
			v.setStyle('display','none');
		});
	} else {
		//alert('maximize');
		var list = summary_yui.Node.all("#play ul li iframe");
		list.each(function(v,k) {
			v.setStyle('display','block');
		});
	}
};

/**
 * If called with argument val=true, checks all nodeTypes
 * checkboxes, otherwise, unchecks all nodeTypes checkboxes
 * and calls filter function to update display.
 */
function selectAllFilter(val){
	var filters = document.getElementsByName('filterType');
	if(!val || val=='false'){ //remove checks for all filters
		for(var t=0;t<filters.length;t++){
			filters[t].checked = false;
		};
	} else { //add checks to all filters
		for(var t=0;t<filters.length;t++){
			filters[t].checked = true;
		};
	};

	filter();
};

/**
 * Determines which nodes the user has selected to show and shows those
 * items and hides the others.
 */
function filter(){
	var showNodes = [];
	var frms = window.frames;

	//get the nodetypes that have been checked
	getFiltered(showNodes);

	/**
	 * Cycles through the individual project frames then through each individual
	 * project's steps and sets style to 'block' (visible) if corresponding checkbox
	 * is checked or 'none' (not visible) otherwise.
	 */
	for(var q=1;q<frms.length;q++){//start at 1 to avoid 'hiddeniframe'
		var insideFrms = window.frames[frms[q].name].frames;
		for(var w=0;w<insideFrms.length;w++){
			if(!showNodes.contains(insideFrms[w].frameNode.type)){
				frms[q].document.getElementById(insideFrms[w].name).style.display = 'none';
			} else {
				frms[q].document.getElementById(insideFrms[w].name).style.display = 'block';
			};
		};
	};
};

/**
 * Takes an empty array and populates it with the nodeTypes that
 * the user has selected to 'show'.
 */
function getFiltered(show){
	var filters = document.getElementsByName('filterType');
	for(var e=0;e<filters.length;e++){
		if(filters[e].checked){
			show.push(filters[e].value);
		};
	};
};
</script>

</head>

<body class="yui-skin-sam" onload='loaded()'>

<style type="text/css" media="screen">
    .yui-dd-proxy {
        text-align: left;
    }
    #play {
        border: 1px solid black;
        padding: 10px;
        margin: 10px;
        zoom: 1;
    }
    #play:after { display: block; clear: both; visibility: hidden; content: '.'; height: 0;}
    #play ul {
        border: 1px solid black;
        margin: 10px;
        float: left;
        padding: 0;
        zoom: 1;
        position: relative;
    }
    #play ul li {
        background-image: none;
        list-style-type: none;
        padding-left: 20px;
        padding: 5px;
        margin: 2px;
        cursor: move;
        zoom: 1;
        position: relative;
    }
    #play ul li.list1 {
        background-color: #8DD5E7;
        border:1px solid #004C6D;
    }
    #play ul li.list2 {
        background-color: #8DD5E7;
        border:1px solid #004C6D;
    }

</style>

<div id="centeredDiv">

<div id="selectprojectlist">
<form method='POST' action='filemanager.html' id='projectlist'>
</form>
</div>

<div id="projectframesDiv">
</div>
<input type="button" value="Minimize All" onclick="doMinimize(true);"/>
<input type="button" value="Maximize All" onclick="doMinimize(false);"/>
<div id='filterDiv'>
	Select Nodes to Show:</br>
	<input type='checkbox' value='BlueJNode' name='filterType' onclick='filter()' CHECKED>BlueJ</input>
	<input type='checkbox' value='BrainstormNode' name='filterType' onclick='filter()' CHECKED>Brainstorm</input>
	<input type='checkbox' value='FillinNode' name='filterType' onclick='filter()' CHECKED>Fillin</input>
	<input type='checkbox' value='FlashNode' name='filterType' onclick='filter()' CHECKED>Flash</input>
	<input type='checkbox' value='HtmlNode' name='filterType' onclick='filter()' CHECKED>Html</input>
	<input type='checkbox' value='MatchSequenceNode' name='filterType' onclick='filter()' CHECKED>MatchSequence</input>
	<input type='checkbox' value='MultipleChoiceNode' name='filterType' onclick='filter()' CHECKED>MultipleChoice</input>
	<input type='checkbox' value='NoteNode' name='filterType' onclick='filter()' CHECKED>Note</input>
	<input type='checkbox' value='OpenResponseNode' name='filterType' onclick='filter()' CHECKED>OpenResponse</input>
	<input type='checkbox' value='OutsideUrlNode' name='filterType' onclick='filter()' CHECKED>OutsideUrl</input>
	<input type='button' value='Select All' onclick='selectAllFilter(true)'/>
	<input type='button' value='Deselect All' onclick='selectAllFilter(false)'/>
</div>
<div id="play">

    <ul id="list2">
        <li class="list2">Item #1</li>
        <li class="list2">Item #2</li>
        <li class="list2">Item #3</li>
        <li class="list2">Item #4</li>

        <li class="list2">Item #5</li>
    </ul>

    <ul id="list1">
        <li class="list1">Item #1</li>
        <li class="list1">Item #2</li>
        <li class="list1">Item #3</li>
        <li class="list1">Item #4</li>

        <li class="list1">Item #5</li>
    </ul>
</div>

<div id='loading'>
<div class='hd'></div>
<div class='bd'></div>
<div class='ft'></div>
</div>


<iframe id="hiddenifrm" name="hiddenifrm" scrolling="auto" frameborder="0" width="0%" height="0%"> [Content for
browsers that don't support iframes goes here.] </iframe></div>
<!-- centerDiv -->
</body>

</html>