var Base64=function(){return{encode:function(d){var b="",f,g,n,c,a,e,l=0;do f=d.charCodeAt(l++),g=d.charCodeAt(l++),n=d.charCodeAt(l++),c=f>>2,f=(f&3)<<4|g>>4,a=(g&15)<<2|n>>6,e=n&63,isNaN(g)?a=e=64:isNaN(n)&&(e=64),b=b+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(c)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(f)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(a)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(e);
while(l<d.length);return b},decode:function(d){var b="",f,g,n,c,a,e=0,d=d.replace(/[^A-Za-z0-9\+\/\=]/g,"");do f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(d.charAt(e++)),g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(d.charAt(e++)),c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(d.charAt(e++)),a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(d.charAt(e++)),f=f<<2|g>>4,g=(g&15)<<
4|c>>2,n=(c&3)<<6|a,b+=String.fromCharCode(f),c!=64&&(b+=String.fromCharCode(g)),a!=64&&(b+=String.fromCharCode(n));while(e<d.length);return b}}}();typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/deps/base64.js");jQuery.cookie=function(d,b,f){if(arguments.length>1&&String(b)!=="[object Object]"){f=jQuery.extend({},f);if(b===null||b===void 0)f.expires=-1;if(typeof f.expires==="number"){var g=f.expires,n=f.expires=new Date;n.setDate(n.getDate()+g)}b=String(b);return document.cookie=[encodeURIComponent(d),"=",f.raw?b:encodeURIComponent(b),f.expires?"; expires="+f.expires.toUTCString():"",f.path?"; path="+f.path:"",f.domain?"; domain="+f.domain:"",f.secure?"; secure":""].join("")}f=b||{};n=f.raw?function(c){return c}:
decodeURIComponent;return(g=RegExp("(?:^|; )"+encodeURIComponent(d)+"=([^;]*)").exec(document.cookie))?n(g[1]):null};typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/deps/jquery.cookie.js");jQuery.url=function(){var d={},b={},f={url:window.location,strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},
g=function(){str=decodeURI(f.url);for(var c=f.parser[f.strictMode?"strict":"loose"].exec(str),a={},e=14;e--;)a[f.key[e]]=c[e]||"";a[f.q.name]={};a[f.key[12]].replace(f.q.parser,function(c,e,d){e&&(a[f.q.name][e]=d)});return a},n=function(){b=g();var c=b.path;d=[];d=b.path.length==1?{}:(c.charAt(c.length-1)=="/"?c.substring(1,c.length-1):path=c.substring(1)).split("/")};return{setMode:function(c){f.strictMode=c=="strict"?!0:!1;return this},setUrl:function(c){f.url=c===void 0?window.location:c;n();
return this},segment:function(c){jQuery.isEmptyObject(b)&&n();return c===void 0?d.length:d[c]===""||d[c]===void 0?null:d[c]},attr:function(c){jQuery.isEmptyObject(b)&&n();return c=="base"?b.port!==null&&b.port!==""?b.protocol+"://"+b.host+":"+b.port+"/":b.protocol+"://"+b.host+"/":b[c]===""?null:b[c]},param:function(c){jQuery.isEmptyObject(b)&&n();return b.queryKey[c]===null?null:b.queryKey[c]}}}();typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/deps/jquery.url.js");(function(d){var d=d||{},b={},f,g;f=function(d,c,a){var e=d.halt=!1;d.error=function(a){throw a;};d.next=function(a){a&&(e=!1);if(!d.halt&&c&&c.length){var a=c.shift(),l=a.shift();e=!0;try{b[l].apply(d,[a,a.length,l])}catch(p){d.error(p)}}return d};for(var l in b)typeof d[l]!=="function"&&function(a){d[a]=function(){var l=Array.prototype.slice.call(arguments);if(a==="onError"){if(c)return b.onError.apply(d,[l,l.length]),d;var p={};b.onError.apply(p,[l,l.length]);return f(p,null,"onError")}l.unshift(a);
if(!c)return f({},[l],a);d.then=d[a];c.push(l);return e?d:d.next()}}(l);a&&(d.then=d[a]);d.call=function(a,e){e.unshift(a);c.unshift(e);d.next(!0)};return d.next()};g=d.addMethod=function(g){for(var c=Array.prototype.slice.call(arguments),a=c.pop(),e=0,l=c.length;e<l;e++)typeof c[e]==="string"&&(b[c[e]]=a);--l||(b["then"+g.substr(0,1).toUpperCase()+g.substr(1)]=a);f(d)};g("chain",function(d){var c=this,a=function(){if(!c.halt){if(!d.length)return c.next(!0);try{null!=d.shift().call(c,a,c.error)&&
a()}catch(e){c.error(e)}}};a()});g("run",function(d,c){for(var a=this,e=function(){a.halt||--c||a.next(!0)},l=function(c){a.error(c)},b=0,g=c;!a.halt&&b<g;b++)null!=d[b].call(a,e,l)&&e()});g("defer",function(d){var c=this;setTimeout(function(){c.next(!0)},d.shift())});g("onError",function(d,c){var a=this;this.error=function(e){a.halt=!0;for(var l=0;l<c;l++)d[l].call(a,e)}})})(this);
addMethod("load",function(d,b){for(var f=[],g=0;g<b;g++)(function(b){f.push(function(c,a){loadScript(d[b],c,a)})})(g);this.call("run",f)});var head=document.getElementsByTagName("head")[0]||document.documentElement;function loadScript(d,b,f){var g=document.createElement("script");g.type="text/javascript";g.src=d;g.onload=b;g.onerror=f;g.onreadystatechange=function(){var d=this.readyState;if(d==="loaded"||d==="complete")g.onreadystatechange=null,b()};head.insertBefore(g,head.firstChild)}
typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/deps/load.js");var MD5=function(){var d=function(a,c){var e=(a&65535)+(c&65535);return(a>>16)+(c>>16)+(e>>16)<<16|e&65535},b=function(a){for(var c=[],e=0;e<a.length*8;e+=8)c[e>>5]|=(a.charCodeAt(e/8)&255)<<e%32;return c},f=function(a){for(var c="",e=0;e<a.length*32;e+=8)c+=String.fromCharCode(a[e>>5]>>>e%32&255);return c},g=function(a){for(var e="",c=0;c<a.length*4;c++)e+="0123456789abcdef".charAt(a[c>>2]>>c%4*8+4&15)+"0123456789abcdef".charAt(a[c>>2]>>c%4*8&15);return e},n=function(a){for(var c="",e,l,d=0;d<a.length*
4;d+=3){e=(a[d>>2]>>8*(d%4)&255)<<16|(a[d+1>>2]>>8*((d+1)%4)&255)<<8|a[d+2>>2]>>8*((d+2)%4)&255;for(l=0;l<4;l++)c+=d*8+l*6>a.length*32?"":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>6*(3-l)&63)}return c},c=function(a,c,e,l,b,g){a=d(d(c,a),d(l,g));return d(a<<b|a>>>32-b,e)},a=function(a,e,l,d,b,g,f){return c(e&l|~e&d,a,e,b,g,f)},e=function(a,e,l,d,b,g,f){return c(e&d|l&~d,a,e,b,g,f)},l=function(a,e,l,d,b,g,f){return c(l^(e|~d),a,e,b,g,f)},h=function(b,g){b[g>>5]|=128<<
g%32;b[(g+64>>>9<<4)+14]=g;for(var f=1732584193,h=-271733879,j=-1732584194,k=271733878,q,n,r,s,m=0;m<b.length;m+=16)q=f,n=h,r=j,s=k,f=a(f,h,j,k,b[m+0],7,-680876936),k=a(k,f,h,j,b[m+1],12,-389564586),j=a(j,k,f,h,b[m+2],17,606105819),h=a(h,j,k,f,b[m+3],22,-1044525330),f=a(f,h,j,k,b[m+4],7,-176418897),k=a(k,f,h,j,b[m+5],12,1200080426),j=a(j,k,f,h,b[m+6],17,-1473231341),h=a(h,j,k,f,b[m+7],22,-45705983),f=a(f,h,j,k,b[m+8],7,1770035416),k=a(k,f,h,j,b[m+9],12,-1958414417),j=a(j,k,f,h,b[m+10],17,-42063),
h=a(h,j,k,f,b[m+11],22,-1990404162),f=a(f,h,j,k,b[m+12],7,1804603682),k=a(k,f,h,j,b[m+13],12,-40341101),j=a(j,k,f,h,b[m+14],17,-1502002290),h=a(h,j,k,f,b[m+15],22,1236535329),f=e(f,h,j,k,b[m+1],5,-165796510),k=e(k,f,h,j,b[m+6],9,-1069501632),j=e(j,k,f,h,b[m+11],14,643717713),h=e(h,j,k,f,b[m+0],20,-373897302),f=e(f,h,j,k,b[m+5],5,-701558691),k=e(k,f,h,j,b[m+10],9,38016083),j=e(j,k,f,h,b[m+15],14,-660478335),h=e(h,j,k,f,b[m+4],20,-405537848),f=e(f,h,j,k,b[m+9],5,568446438),k=e(k,f,h,j,b[m+14],9,-1019803690),
j=e(j,k,f,h,b[m+3],14,-187363961),h=e(h,j,k,f,b[m+8],20,1163531501),f=e(f,h,j,k,b[m+13],5,-1444681467),k=e(k,f,h,j,b[m+2],9,-51403784),j=e(j,k,f,h,b[m+7],14,1735328473),h=e(h,j,k,f,b[m+12],20,-1926607734),f=c(h^j^k,f,h,b[m+5],4,-378558),k=c(f^h^j,k,f,b[m+8],11,-2022574463),j=c(k^f^h,j,k,b[m+11],16,1839030562),h=c(j^k^f,h,j,b[m+14],23,-35309556),f=c(h^j^k,f,h,b[m+1],4,-1530992060),k=c(f^h^j,k,f,b[m+4],11,1272893353),j=c(k^f^h,j,k,b[m+7],16,-155497632),h=c(j^k^f,h,j,b[m+10],23,-1094730640),f=c(h^j^
k,f,h,b[m+13],4,681279174),k=c(f^h^j,k,f,b[m+0],11,-358537222),j=c(k^f^h,j,k,b[m+3],16,-722521979),h=c(j^k^f,h,j,b[m+6],23,76029189),f=c(h^j^k,f,h,b[m+9],4,-640364487),k=c(f^h^j,k,f,b[m+12],11,-421815835),j=c(k^f^h,j,k,b[m+15],16,530742520),h=c(j^k^f,h,j,b[m+2],23,-995338651),f=l(f,h,j,k,b[m+0],6,-198630844),k=l(k,f,h,j,b[m+7],10,1126891415),j=l(j,k,f,h,b[m+14],15,-1416354905),h=l(h,j,k,f,b[m+5],21,-57434055),f=l(f,h,j,k,b[m+12],6,1700485571),k=l(k,f,h,j,b[m+3],10,-1894986606),j=l(j,k,f,h,b[m+10],
15,-1051523),h=l(h,j,k,f,b[m+1],21,-2054922799),f=l(f,h,j,k,b[m+8],6,1873313359),k=l(k,f,h,j,b[m+15],10,-30611744),j=l(j,k,f,h,b[m+6],15,-1560198380),h=l(h,j,k,f,b[m+13],21,1309151649),f=l(f,h,j,k,b[m+4],6,-145523070),k=l(k,f,h,j,b[m+11],10,-1120210379),j=l(j,k,f,h,b[m+2],15,718787259),h=l(h,j,k,f,b[m+9],21,-343485551),f=d(f,q),h=d(h,n),j=d(j,r),k=d(k,s);return[f,h,j,k]},q=function(a,e){var c=b(a);c.length>16&&(c=h(c,a.length*8));for(var l=Array(16),d=Array(16),f=0;f<16;f++)l[f]=c[f]^909522486,d[f]=
c[f]^1549556828;c=h(l.concat(b(e)),512+e.length*8);return h(d.concat(c),640)};return{hexdigest:function(a){return g(h(b(a),a.length*8))},b64digest:function(a){return n(h(b(a),a.length*8))},hash:function(a){return f(h(b(a),a.length*8))},hmac_hexdigest:function(a,e){return g(q(a,e))},hmac_b64digest:function(a,e){return n(q(a,e))},hmac_hash:function(a,e){return f(q(a,e))},test:function(){return MD5.hexdigest("abc")==="900150983cd24fb0d6963f7d28e17f72"}}}();
typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/deps/md5.js");if(!Function.prototype.bind)Function.prototype.bind=function(d){var b=this,f=Array.prototype.slice,g=Array.prototype.concat,n=f.call(arguments,1);return function(){return b.apply(d?d:this,g.call(n,f.call(arguments,0)))}};if(!Array.prototype.indexOf)Array.prototype.indexOf=function(d,b){var f=this.length,g=Number(b)||0,g=g<0?Math.ceil(g):Math.floor(g);for(g<0&&(g+=f);g<f;g++)if(g in this&&this[g]===d)return g;return-1};
(function(d){function b(a,e){return new c.Builder(a,e)}function f(a){return new c.Builder("message",a)}function g(a){return new c.Builder("iq",a)}function n(a){return new c.Builder("presence",a)}var c;c={VERSION:"@VERSION@",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",
SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas"},addNamespace:function(a,e){c.NS[a]=e},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3},TIMEOUT:1.1,SECONDARY_TIMEOUT:0.1,
forEachChild:function(a,e,b){var d,f;for(d=0;d<a.childNodes.length;d++)f=a.childNodes[d],f.nodeType==c.ElementType.NORMAL&&(!e||this.isTagEqual(f,e))&&b(f)},isTagEqual:function(a,e){return a.tagName.toLowerCase()==e.toLowerCase()},_xmlGenerator:null,_makeGenerator:function(){var a;window.ActiveXObject?(a=this._getIEXmlDom(),a.appendChild(a.createElement("strophe"))):a=document.implementation.createDocument("jabber:client","strophe",null);return a},xmlGenerator:function(){if(!c._xmlGenerator)c._xmlGenerator=
c._makeGenerator();return c._xmlGenerator},_getIEXmlDom:function(){for(var a=null,e=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"],c=0;c<e.length;c++)if(a===null)try{a=new ActiveXObject(e[c])}catch(b){a=null}else break;return a},xmlElement:function(a){if(!a)return null;var e=c.xmlGenerator().createElement(a),b,d,f;for(b=1;b<arguments.length;b++)if(arguments[b])if(typeof arguments[b]==
"string"||typeof arguments[b]=="number")e.appendChild(c.xmlTextNode(arguments[b]));else if(typeof arguments[b]=="object"&&typeof arguments[b].sort=="function")for(d=0;d<arguments[b].length;d++)typeof arguments[b][d]=="object"&&typeof arguments[b][d].sort=="function"&&e.setAttribute(arguments[b][d][0],arguments[b][d][1]);else if(typeof arguments[b]=="object")for(f in arguments[b])arguments[b].hasOwnProperty(f)&&e.setAttribute(f,arguments[b][f]);return e},xmlescape:function(a){a=a.replace(/\&/g,"&amp;");
a=a.replace(/</g,"&lt;");return a=a.replace(/>/g,"&gt;")},xmlTextNode:function(a){a=c.xmlescape(a);return c.xmlGenerator().createTextNode(a)},getText:function(a){if(!a)return null;var e="";a.childNodes.length===0&&a.nodeType==c.ElementType.TEXT&&(e+=a.nodeValue);for(var b=0;b<a.childNodes.length;b++)a.childNodes[b].nodeType==c.ElementType.TEXT&&(e+=a.childNodes[b].nodeValue);return e},copyElement:function(a){var e,b;if(a.nodeType==c.ElementType.NORMAL){b=c.xmlElement(a.tagName);for(e=0;e<a.attributes.length;e++)b.setAttribute(a.attributes[e].nodeName.toLowerCase(),
a.attributes[e].value);for(e=0;e<a.childNodes.length;e++)b.appendChild(c.copyElement(a.childNodes[e]))}else a.nodeType==c.ElementType.TEXT&&(b=c.xmlTextNode(a.nodeValue));return b},escapeNode:function(a){return a.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(a){return a.replace(/\\20/g,
" ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(a){return a.indexOf("@")<0?null:a.split("@")[0]},getDomainFromJid:function(a){a=c.getBareJidFromJid(a);return a.indexOf("@")<0?a:(a=a.split("@"),a.splice(0,1),a.join("@"))},getResourceFromJid:function(a){a=a.split("/");if(a.length<2)return null;a.splice(0,1);return a.join("/")},getBareJidFromJid:function(a){return a?
a.split("/")[0]:null},log:function(){},debug:function(a){this.log(this.LogLevel.DEBUG,a)},info:function(a){this.log(this.LogLevel.INFO,a)},warn:function(a){this.log(this.LogLevel.WARN,a)},error:function(a){this.log(this.LogLevel.ERROR,a)},fatal:function(a){this.log(this.LogLevel.FATAL,a)},serialize:function(a){var e;if(!a)return null;typeof a.tree==="function"&&(a=a.tree());var b=a.nodeName,d,f;a.getAttribute("_realname")&&(b=a.getAttribute("_realname"));e="<"+b;for(d=0;d<a.attributes.length;d++)a.attributes[d].nodeName!=
"_realname"&&(e+=" "+a.attributes[d].nodeName.toLowerCase()+"='"+a.attributes[d].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/</g,"&lt;")+"'");if(a.childNodes.length>0){e+=">";for(d=0;d<a.childNodes.length;d++)f=a.childNodes[d],f.nodeType==c.ElementType.NORMAL?e+=c.serialize(f):f.nodeType==c.ElementType.TEXT&&(e+=f.nodeValue);e+="</"+b+">"}else e+="/>";return e},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(a,e){c._connectionPlugins[a]=e}};c.Builder=function(a,e){if(a==
"presence"||a=="message"||a=="iq")e&&!e.xmlns?e.xmlns=c.NS.CLIENT:e||(e={xmlns:c.NS.CLIENT});this.node=this.nodeTree=c.xmlElement(a,e)};c.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return c.serialize(this.nodeTree)},up:function(){this.node=this.node.parentNode;return this},attrs:function(a){for(var e in a)a.hasOwnProperty(e)&&this.node.setAttribute(e,a[e]);return this},c:function(a,e){var b=c.xmlElement(a,e);this.node.appendChild(b);this.node=b;return this},cnode:function(a){var e=
c.xmlGenerator(),a=e.importNode?e.importNode(a,!0):c.copyElement(a);this.node.appendChild(a);this.node=a;return this},t:function(a){this.node.appendChild(c.xmlTextNode(a));return this}};c.Handler=function(a,e,b,d,f,g,n){this.handler=a;this.ns=e;this.name=b;this.type=d;this.id=f;this.options=n||{matchbare:!1};if(!this.options.matchBare)this.options.matchBare=!1;this.from=this.options.matchBare?g?c.getBareJidFromJid(g):null:g;this.user=!0};c.Handler.prototype={isMatch:function(a){var e,b=null,b=this.options.matchBare?
c.getBareJidFromJid(a.getAttribute("from")):a.getAttribute("from");e=!1;if(this.ns){var d=this;c.forEachChild(a,null,function(a){a.getAttribute("xmlns")==d.ns&&(e=!0)});e=e||a.getAttribute("xmlns")==this.ns}else e=!0;return e&&(!this.name||c.isTagEqual(a,this.name))&&(!this.type||a.getAttribute("type")==this.type)&&(!this.id||a.getAttribute("id")==this.id)&&(!this.from||b==this.from)?!0:!1},run:function(a){var e=null;try{e=this.handler(a)}catch(b){throw b.sourceURL?c.fatal("error: "+this.handler+
" "+b.sourceURL+":"+b.line+" - "+b.name+": "+b.message):b.fileName?(typeof console!="undefined"&&(console.trace(),console.error(this.handler," - error - ",b,b.message)),c.fatal("error: "+this.handler+" "+b.fileName+":"+b.lineNumber+" - "+b.name+": "+b.message)):c.fatal("error: "+this.handler),b;}return e},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}};c.TimedHandler=function(a,e){this.period=a;this.handler=e;this.lastCalled=(new Date).getTime();this.user=
!0};c.TimedHandler.prototype={run:function(){this.lastCalled=(new Date).getTime();return this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}};c.Request=function(a,e,b,d){this.id=++c._requestId;this.xmlData=a;this.data=c.serialize(a);this.func=this.origFunc=e;this.rid=b;this.date=NaN;this.sends=d||0;this.abort=!1;this.dead=null;this.age=function(){return!this.date?0:(new Date-this.date)/1E3};this.timeDead=
function(){return!this.dead?0:(new Date-this.dead)/1E3};this.xhr=this._newXHR()};c.Request.prototype={getResponse:function(){var a=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if(a=this.xhr.responseXML.documentElement,a.tagName=="parsererror")throw c.error("invalid response received"),c.error("responseText: "+this.xhr.responseText),c.error("responseXML: "+c.serialize(this.xhr.responseXML)),"parsererror";}else this.xhr.responseText&&(c.error("invalid response received"),c.error("responseText: "+
this.xhr.responseText),c.error("responseXML: "+c.serialize(this.xhr.responseXML)));return a},_newXHR:function(){var a=null;window.XMLHttpRequest?(a=new XMLHttpRequest,a.overrideMimeType&&a.overrideMimeType("text/xml")):window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP"));a.onreadystatechange=this.func.bind(null,this);return a}};c.Connection=function(a){this.service=a;this.jid="";this.rid=Math.floor(Math.random()*4294967295);this.features=this.streamId=this.sid=null;this.do_bind=this.do_session=
!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._disconnectTimeout=this._idleTimeout=null;this.connected=this.disconnecting=this.authenticated=!1;this.errors=0;this.paused=!1;this.hold=1;this.wait=60;this.window=5;this._data=[];this._requests=[];this._uniqueId=Math.round(Math.random()*1E4);this._sasl_challenge_handler=this._sasl_failure_handler=this._sasl_success_handler=null;this._idleTimeout=setTimeout(this._onIdle.bind(this),
100);for(var e in c._connectionPlugins)if(c._connectionPlugins.hasOwnProperty(e))a=function(){},a.prototype=c._connectionPlugins[e],this[e]=new a,this[e].init(this)};c.Connection.prototype={reset:function(){this.rid=Math.floor(Math.random()*4294967295);this.streamId=this.sid=null;this.do_bind=this.do_session=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this.connected=this.disconnecting=this.authenticated=!1;this.errors=
0;this._requests=[];this._uniqueId=Math.round(Math.random()*1E4)},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(a){return typeof a=="string"||typeof a=="number"?++this._uniqueId+":"+a:++this._uniqueId+""},connect:function(a,e,b,d,f){this.jid=a;this.pass=e;this.connect_callback=b;this.authenticated=this.connected=this.disconnecting=!1;this.errors=0;this.wait=d||this.wait;this.hold=f||this.hold;this.domain=c.getDomainFromJid(this.jid);a=this._buildBody().attrs({to:this.domain,
"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":c.NS.BOSH});this._changeConnectStatus(c.Status.CONNECTING,null);this._requests.push(new c.Request(a.tree(),this._onRequestStateChange.bind(this,this._connect_cb.bind(this)),a.tree().getAttribute("rid")));this._throttledRequestHandler()},attach:function(a,e,b,d,f,g,n){this.jid=a;this.sid=e;this.rid=b;this.connect_callback=d;this.domain=c.getDomainFromJid(this.jid);this.connected=
this.authenticated=!0;this.wait=f||this.wait;this.hold=g||this.hold;this.window=n||this.window;this._changeConnectStatus(c.Status.ATTACHED,null)},xmlInput:function(){},xmlOutput:function(){},rawInput:function(){},rawOutput:function(){},send:function(a){if(a!==null){if(typeof a.sort==="function")for(var e=0;e<a.length;e++)this._queueData(a[e]);else typeof a.tree==="function"?this._queueData(a.tree()):this._queueData(a);this._throttledRequestHandler();clearTimeout(this._idleTimeout);this._idleTimeout=
setTimeout(this._onIdle.bind(this),100)}},flush:function(){clearTimeout(this._idleTimeout);this._onIdle()},sendIQ:function(a,e,c,b){var d=null,f=this;typeof a.tree==="function"&&(a=a.tree());var g=a.getAttribute("id");g||(g=this.getUniqueId("sendIQ"),a.setAttribute("id",g));var n=this.addHandler(function(a){d&&f.deleteTimedHandler(d);var b=a.getAttribute("type");if(b=="result")e&&e(a);else if(b=="error")c&&c(a);else throw{name:"StropheError",message:"Got bad IQ type of "+b};},null,"iq",null,g);b&&
(d=this.addTimedHandler(b,function(){f.deleteHandler(n);c&&c(null);return!1}));this.send(a);return g},_queueData:function(a){if(a===null||!a.tagName||!a.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(a)},_sendRestart:function(){this._data.push("restart");this._throttledRequestHandler();clearTimeout(this._idleTimeout);this._idleTimeout=setTimeout(this._onIdle.bind(this),100)},addTimedHandler:function(a,e){var b=new c.TimedHandler(a,e);this.addTimeds.push(b);
return b},deleteTimedHandler:function(a){this.removeTimeds.push(a)},addHandler:function(a,e,b,d,f,g,n){a=new c.Handler(a,e,b,d,f,g,n);this.addHandlers.push(a);return a},deleteHandler:function(a){this.removeHandlers.push(a)},disconnect:function(a){this._changeConnectStatus(c.Status.DISCONNECTING,a);c.info("Disconnect was called because: "+a);if(this.connected)this._disconnectTimeout=this._addSysTimedHandler(3E3,this._onDisconnectTimeout.bind(this)),this._sendTerminate()},_changeConnectStatus:function(a,
e){for(var b in c._connectionPlugins)if(c._connectionPlugins.hasOwnProperty(b)){var d=this[b];if(d.statusChanged)try{d.statusChanged(a,e)}catch(f){c.error(""+b+" plugin caused an exception changing status: "+f)}}if(this.connect_callback)try{this.connect_callback(a,e)}catch(g){c.error("User connection callback caused an exception: "+g)}},_buildBody:function(){var a=b("body",{rid:this.rid++,xmlns:c.NS.HTTPBIND});this.sid!==null&&a.attrs({sid:this.sid});return a},_removeRequest:function(a){c.debug("removing request");
var e;for(e=this._requests.length-1;e>=0;e--)a==this._requests[e]&&this._requests.splice(e,1);a.xhr.onreadystatechange=function(){};this._throttledRequestHandler()},_restartRequest:function(a){var c=this._requests[a];if(c.dead===null)c.dead=new Date;this._processRequest(a)},_processRequest:function(a){var e=this._requests[a],b=-1;try{if(e.xhr.readyState==4)b=e.xhr.status}catch(d){c.error("caught an error in _requests["+a+"], reqStatus: "+b)}typeof b=="undefined"&&(b=-1);if(e.sends>5)this._onDisconnectTimeout();
else{var f=e.age(),f=!isNaN(f)&&f>Math.floor(c.TIMEOUT*this.wait),g=e.dead!==null&&e.timeDead()>Math.floor(c.SECONDARY_TIMEOUT*this.wait),b=e.xhr.readyState==4&&(b<1||b>=500);if(f||g||b)g&&c.error("Request "+this._requests[a].id+" timed out (secondary), restarting"),e.abort=!0,e.xhr.abort(),e.xhr.onreadystatechange=function(){},this._requests[a]=new c.Request(e.xmlData,e.origFunc,e.rid,e.sends),e=this._requests[a];if(e.xhr.readyState===0){c.debug("request id "+e.id+"."+e.sends+" posting");try{e.xhr.open("POST",
this.service,!0)}catch(n){c.error("XHR open failed.");this.connected||this._changeConnectStatus(c.Status.CONNFAIL,"bad-service");this.disconnect();return}a=function(){e.date=new Date;e.xhr.send(e.data)};e.sends>1?setTimeout(a,Math.min(Math.floor(c.TIMEOUT*this.wait),Math.pow(e.sends,3))*1E3):a();e.sends++;this.xmlOutput(e.xmlData);this.rawOutput(e.data)}else c.debug("_processRequest: "+(a===0?"first":"second")+" request has readyState of "+e.xhr.readyState)}},_throttledRequestHandler:function(){this._requests?
c.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):c.debug("_throttledRequestHandler called with undefined requests");this._requests&&this._requests.length!==0&&(this._requests.length>0&&this._processRequest(0),this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))},_onRequestStateChange:function(a,e){c.debug("request id "+e.id+"."+e.sends+" state changed to "+e.xhr.readyState);if(e.abort)e.abort=!1;else{var b;
if(e.xhr.readyState==4){b=0;try{b=e.xhr.status}catch(d){}typeof b=="undefined"&&(b=0);if(this.disconnecting&&b>=400)this._hitError(b);else{var f=this._requests[0]==e,g=this._requests[1]==e;if(b>0&&b<500||e.sends>5)this._removeRequest(e),c.debug("request id "+e.id+" should now be removed");if(b==200)(g||f&&this._requests.length>0&&this._requests[0].age()>Math.floor(c.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),c.debug("request id "+e.id+"."+e.sends+" got 200"),a(e),this.errors=0;else if(c.error("request id "+
e.id+"."+e.sends+" error "+b+" happened"),b===0||b>=400&&b<600||b>=12E3)this._hitError(b),b>=400&&b<500&&(this._changeConnectStatus(c.Status.DISCONNECTING,null),this._doDisconnect());b>0&&b<500||e.sends>5||this._throttledRequestHandler()}}}},_hitError:function(a){this.errors++;c.warn("request errored, status: "+a+", number of errors: "+this.errors);this.errors>4&&this._onDisconnectTimeout()},_doDisconnect:function(){c.info("_doDisconnect was called");this.disconnecting=this.authenticated=!1;this.streamId=
this.sid=null;this.rid=Math.floor(Math.random()*4294967295);if(this.connected)this._changeConnectStatus(c.Status.DISCONNECTED,null),this.connected=!1;this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[]},_dataRecv:function(a){try{var b=a.getResponse()}catch(d){if(d!="parsererror")throw d;this.disconnect("strophe-parsererror")}if(b!==null){this.xmlInput(b);for(this.rawInput(c.serialize(b));this.removeHandlers.length>0;)a=this.removeHandlers.pop(),
a=this.handlers.indexOf(a),a>=0&&this.handlers.splice(a,1);for(;this.addHandlers.length>0;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._requests.length===0)this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null,this._doDisconnect();else if(a=b.getAttribute("type"),a!==null&&a=="terminate")this.disconnecting||(a=b.getAttribute("condition"),b=b.getElementsByTagName("conflict"),a!==null?(a=="remote-stream-error"&&b.length>0&&(a="conflict"),this._changeConnectStatus(c.Status.CONNFAIL,
a)):this._changeConnectStatus(c.Status.CONNFAIL,"unknown"),this.disconnect());else{var f=this;c.forEachChild(b,null,function(a){var b,c;c=f.handlers;f.handlers=[];for(b=0;b<c.length;b++){var e=c[b];e.isMatch(a)&&(f.authenticated||!e.user)?e.run(a)&&f.handlers.push(e):f.handlers.push(e)}})}}},_sendTerminate:function(){c.info("_sendTerminate was called");var a=this._buildBody().attrs({type:"terminate"});this.authenticated&&a.c("presence",{xmlns:c.NS.CLIENT,type:"unavailable"});this.disconnecting=!0;
this._requests.push(new c.Request(a.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),a.tree().getAttribute("rid")));this._throttledRequestHandler()},_connect_cb:function(a){c.info("_connect_cb was called");this.connected=!0;if(a=a.getResponse()){this.xmlInput(a);this.rawInput(c.serialize(a));var e=a.getAttribute("type");if(e!==null&&e=="terminate")e=a.getAttribute("condition"),a=a.getElementsByTagName("conflict"),e!==null?(e=="remote-stream-error"&&a.length>0&&(e="conflict"),
this._changeConnectStatus(c.Status.CONNFAIL,e)):this._changeConnectStatus(c.Status.CONNFAIL,"unknown");else{if(!this.sid)this.sid=a.getAttribute("sid");if(!this.stream_id)this.stream_id=a.getAttribute("authid");if(e=a.getAttribute("requests"))this.window=parseInt(e,10);if(e=a.getAttribute("hold"))this.hold=parseInt(e,10);if(e=a.getAttribute("wait"))this.wait=parseInt(e,10);var d=e=!1,f=!1,a=a.getElementsByTagName("mechanism"),n,p;if(a.length>0){for(n=0;n<a.length;n++)p=c.getText(a[n]),p=="DIGEST-MD5"?
d=!0:p=="PLAIN"?e=!0:p=="ANONYMOUS"&&(f=!0);c.getNodeFromJid(this.jid)===null&&f?(this._changeConnectStatus(c.Status.AUTHENTICATING,null),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(b("auth",{xmlns:c.NS.SASL,mechanism:"ANONYMOUS"}).tree())):c.getNodeFromJid(this.jid)===null?(this._changeConnectStatus(c.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),
this.disconnect()):d?(this._changeConnectStatus(c.Status.AUTHENTICATING,null),this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge1_cb.bind(this),null,"challenge",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(b("auth",{xmlns:c.NS.SASL,mechanism:"DIGEST-MD5"}).tree())):e?(a=c.getBareJidFromJid(this.jid),a+="\000",a+=c.getNodeFromJid(this.jid),a+="\000",a+=this.pass,this._changeConnectStatus(c.Status.AUTHENTICATING,
null),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),a=Base64.encode(a),this.send(b("auth",{xmlns:c.NS.SASL,mechanism:"PLAIN"}).t(a).tree())):(this._changeConnectStatus(c.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(g({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:c.NS.AUTH}).c("username",
{}).t(c.getNodeFromJid(this.jid)).tree()))}else a=this._buildBody(),this._requests.push(new c.Request(a.tree(),this._onRequestStateChange.bind(this,this._connect_cb.bind(this)),a.tree().getAttribute("rid"))),this._throttledRequestHandler()}}},_sasl_challenge1_cb:function(a){var e=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/,d=Base64.decode(c.getText(a)),a=MD5.hexdigest(Math.random()*1234567890),f="",g=null,n="",o;for(this.deleteHandler(this._sasl_failure_handler);d.match(e);)switch(o=d.match(e),d=d.replace(o[0],
""),o[2]=o[2].replace(/^"(.+)"$/,"$1"),o[1]){case "realm":f=o[2];break;case "nonce":n=o[2];break;case "host":g=o[2]}e="xmpp/"+this.domain;g!==null&&(e=e+"/"+g);g=MD5.hash(c.getNodeFromJid(this.jid)+":"+f+":"+this.pass)+":"+n+":"+a;d="AUTHENTICATE:"+e;o="";o+="username="+this._quote(c.getNodeFromJid(this.jid))+",";o+="realm="+this._quote(f)+",";o+="nonce="+this._quote(n)+",";o+="cnonce="+this._quote(a)+",";o+='nc="00000001",';o+='qop="auth",';o+="digest-uri="+this._quote(e)+",";o+="response="+this._quote(MD5.hexdigest(MD5.hexdigest(g)+
":"+n+":00000001:"+a+":auth:"+MD5.hexdigest(d)))+",";o+='charset="utf-8"';this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge2_cb.bind(this),null,"challenge",null,null);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(b("response",{xmlns:c.NS.SASL}).t(Base64.encode(o)).tree());return!1},_quote:function(a){return'"'+
a.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},_sasl_challenge2_cb:function(){this.deleteHandler(this._sasl_success_handler);this.deleteHandler(this._sasl_failure_handler);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(b("response",{xmlns:c.NS.SASL}).tree());return!1},_auth1_cb:function(){var a=g({type:"set",id:"_auth_2"}).c("query",
{xmlns:c.NS.AUTH}).c("username",{}).t(c.getNodeFromJid(this.jid)).up().c("password").t(this.pass);if(!c.getResourceFromJid(this.jid))this.jid=c.getBareJidFromJid(this.jid)+"/strophe";a.up().c("resource",{}).t(c.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2");this.send(a.tree());return!1},_sasl_success_cb:function(){c.info("SASL authentication succeeded.");this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler)this.deleteHandler(this._sasl_challenge_handler),
this._sasl_challenge_handler=null;this._addSysHandler(this._sasl_auth1_cb.bind(this),null,"stream:features",null,null);this._sendRestart();return!1},_sasl_auth1_cb:function(a){this.features=a;var b,d;for(b=0;b<a.childNodes.length;b++){d=a.childNodes[b];if(d.nodeName=="bind")this.do_bind=!0;if(d.nodeName=="session")this.do_session=!0}this.do_bind?(this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2"),(a=c.getResourceFromJid(this.jid))?this.send(g({type:"set",id:"_bind_auth_2"}).c("bind",
{xmlns:c.NS.BIND}).c("resource",{}).t(a).tree()):this.send(g({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:c.NS.BIND}).tree())):this._changeConnectStatus(c.Status.AUTHFAIL,null);return!1},_sasl_bind_cb:function(a){if(a.getAttribute("type")=="error")return c.info("SASL binding failed."),this._changeConnectStatus(c.Status.AUTHFAIL,null),!1;a=a.getElementsByTagName("bind");if(a.length>0){if(a=a[0].getElementsByTagName("jid"),a.length>0)this.jid=c.getText(a[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),
null,null,null,"_session_auth_2"),this.send(g({type:"set",id:"_session_auth_2"}).c("session",{xmlns:c.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(c.Status.CONNECTED,null))}else return c.info("SASL binding failed."),this._changeConnectStatus(c.Status.AUTHFAIL,null),!1},_sasl_session_cb:function(a){a.getAttribute("type")=="result"?(this.authenticated=!0,this._changeConnectStatus(c.Status.CONNECTED,null)):a.getAttribute("type")=="error"&&(c.info("Session creation failed."),
this._changeConnectStatus(c.Status.AUTHFAIL,null));return!1},_sasl_failure_cb:function(){if(this._sasl_success_handler)this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null;if(this._sasl_challenge_handler)this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null;this._changeConnectStatus(c.Status.AUTHFAIL,null);return!1},_auth2_cb:function(a){a.getAttribute("type")=="result"?(this.authenticated=!0,this._changeConnectStatus(c.Status.CONNECTED,null)):
a.getAttribute("type")=="error"&&(this._changeConnectStatus(c.Status.AUTHFAIL,null),this.disconnect());return!1},_addSysTimedHandler:function(a,b){var d=new c.TimedHandler(a,b);d.user=!1;this.addTimeds.push(d);return d},_addSysHandler:function(a,b,d,f,g){a=new c.Handler(a,b,d,f,g);a.user=!1;this.addHandlers.push(a);return a},_onDisconnectTimeout:function(){c.info("_onDisconnectTimeout was called");for(var a;this._requests.length>0;)a=this._requests.pop(),a.abort=!0,a.xhr.abort(),a.xhr.onreadystatechange=
function(){};this._doDisconnect();return!1},_onIdle:function(){for(var a,b,d,f;this.addTimeds.length>0;)this.timedHandlers.push(this.addTimeds.pop());for(;this.removeTimeds.length>0;)b=this.removeTimeds.pop(),a=this.timedHandlers.indexOf(b),a>=0&&this.timedHandlers.splice(a,1);var g=(new Date).getTime();f=[];for(a=0;a<this.timedHandlers.length;a++)if(b=this.timedHandlers[a],this.authenticated||!b.user)d=b.lastCalled+b.period,d-g<=0?b.run()&&f.push(b):f.push(b);this.timedHandlers=f;this.authenticated&&
this._requests.length===0&&this._data.length===0&&!this.disconnecting&&(c.info("no requests during idle cycle, sending blank request"),this._data.push(null));if(this._requests.length<2&&this._data.length>0&&!this.paused){b=this._buildBody();for(a=0;a<this._data.length;a++)this._data[a]!==null&&(this._data[a]==="restart"?b.attrs({to:this.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":c.NS.BOSH}):b.cnode(this._data[a]).up());delete this._data;this._data=[];this._requests.push(new c.Request(b.tree(),
this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),b.tree().getAttribute("rid")));this._processRequest(this._requests.length-1)}this._requests.length>0&&(a=this._requests[0].age(),this._requests[0].dead!==null&&this._requests[0].timeDead()>Math.floor(c.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),a>Math.floor(c.TIMEOUT*this.wait)&&(c.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(c.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler()));
clearTimeout(this._idleTimeout);this._idleTimeout=setTimeout(this._onIdle.bind(this),100)}};d&&d(c,b,f,g,n)})(function(d,b,f,g,n){window.Strophe=d;window.$build=b;window.$msg=f;window.$iq=g;window.$pres=n});typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/deps/strophe.js");function loadScript(d,b,f){var g=document.createElement("script");g.type="text/javascript";g.src=d;g.onload=b;g.onerror=f;g.onreadystatechange=function(){var d=this.readyState;if(d==="loaded"||d==="complete")g.onreadystatechange=null,b()};head.insertBefore(g,head.firstChild)}
(function(d){var d=d||{},b={},f,g;f=function(d,c,a){var e=d.halt=!1;d.error=function(a){throw a;};d.next=function(a){a&&(e=!1);if(!d.halt&&c&&c.length){var a=c.shift(),f=a.shift();e=!0;try{b[f].apply(d,[a,a.length,f])}catch(g){d.error(g)}}return d};for(var g in b)typeof d[g]!=="function"&&function(a){d[a]=function(){var g=Array.prototype.slice.call(arguments);if(a==="onError"){if(c)return b.onError.apply(d,[g,g.length]),d;var l={};b.onError.apply(l,[g,g.length]);return f(l,null,"onError")}g.unshift(a);
if(!c)return f({},[g],a);d.then=d[a];c.push(g);return e?d:d.next()}}(g);a&&(d.then=d[a]);d.call=function(a,b){b.unshift(a);c.unshift(b);d.next(!0)};return d.next()};g=d.addMethod=function(g){for(var c=Array.prototype.slice.call(arguments),a=c.pop(),e=0,l=c.length;e<l;e++)typeof c[e]==="string"&&(b[c[e]]=a);--l||(b["then"+g.substr(0,1).toUpperCase()+g.substr(1)]=a);f(d)};g("chain",function(b){var c=this,a=function(){if(!c.halt){if(!b.length)return c.next(!0);try{null!=b.shift().call(c,a,c.error)&&
a()}catch(d){c.error(d)}}};a()});g("run",function(b,c){for(var a=this,d=function(){a.halt||--c||a.next(!0)},f=function(b){a.error(b)},g=0,q=c;!a.halt&&g<q;g++)null!=b[g].call(a,d,f)&&d()});g("defer",function(b){var c=this;setTimeout(function(){c.next(!0)},b.shift())});g("onError",function(b,c){var a=this;this.error=function(d){a.halt=!0;for(var f=0;f<c;f++)b[f].call(a,d)}})})(this);
addMethod("load",function(d,b){for(var f=[],g=0;g<b;g++)(function(b){f.push(function(c,a){loadScript(d[b],c,a)})})(g);this.call("run",f)});head=document.getElementsByTagName("head")[0]||document.documentElement;if(!window.console){var names=["log","debug","info","warn","error","assert","dir","dirxml","group","groupEnd","time","timeEnd","count","trace","profile","profileEnd"];window.console={};for(var i=0;i<names.length;++i)window.console[names[i]]=function(){}}var Sail=window.Sail||{};
Sail.load=function(){return load("https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js","js/sail.js/deps/md5.js","js/sail.js/deps/base64.js").then("js/sail.js/deps/strophe.js","https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.2/jquery-ui.js","js/sail.js/deps/jquery.url.js","js/sail.js/deps/jquery.cookie.js").then("js/sail.js/sail.rollcall.js","js/sail.js/sail.strophe.js","js/sail.js/sail.ui.js")};Sail.Event=function(d,b){this.data={};this.data.eventType=d;this.data.payload=b};
Sail.Event.prototype={toJSON:function(){return JSON.stringify(this.data)}};
Sail.autobindEvents=function(d,b){var b=b||{},f;for(f in d.events)if(d.events.hasOwnProperty(f)&&typeof d.events[f]=="function"&&f.match(/^on/)){event=f.replace(/^on/,"");event=event.charAt(0).toLowerCase()+event.slice(1);console.debug("Sail: auto-binding event '"+event+"' to "+f);try{b.pre&&$(d).bind(event,b.pre),$(d).bind(event,d.events[f]),b.post&&$(d).bind(event,b.post)}catch(g){throw alert("Sail: failed to auto-bind event! '"+event+"' may be a reserved word."),g;}}};
Sail.generateSailEventHandler=function(d){return function(b){msg=$(b);body=$(msg).children("body").text();sev=null;try{sev=JSON.parse(body)}catch(f){console.log("couldn't parse message, ignoring: "+f);return}sev.from=msg.attr("from");sev.to=msg.attr("to");sev.stanza=b;d.events.sail[sev.eventType]?$(d).trigger(d.events.sail[sev.eventType],sev):console.log("UNHANDLED EVENT "+sev.eventType,sev);return!0}};typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/sail.js");Sail=window.Sail||{};Sail.Rollcall={};Sail.Rollcall.Client=function(d){this.url=d};
Sail.Rollcall.Client.prototype={getCurrentToken:function(){return $.url.param("token")},redirectToLogin:function(){window.location.replace(this.url+"/login?destination="+escape(window.location.href))},fetchSessionForToken:function(d,b){currentUrl=$.url.attr("source");$.url.setUrl(this.url);rollcallHost=$.url.attr("host");rollcallPort=$.url.attr("port");rollcallProtocol=$.url.attr("protocol");$.url.setUrl(currentUrl);rollcallHost==$.url.attr("host")&&rollcallPort==$.url.attr("port")&&rollcallProtocol==
$.url.attr("protocol")?this.fetchSessionForTokenUsingREST(d,b):this.fetchSessionForTokenUsingJSONP(d,b)},fetchSessionForTokenUsingREST:function(d,b){var f=this;return $.ajax({url:f.url+"/sessions/validate_token.json",dataType:"json",data:{token:d},success:b,failure:function(b){console.log(b);throw"Error response from Rollcall at "+f.url;}})},fetchXMPPAuthentication:function(d){var b=this;return $.ajax({url:b.url,dataType:"json",data:{_method:"GET"},success:function(f){if(f.error)throw console.log(f),
f.error.data+" (from "+b.url+")";else d(f)}})},fetchSessionForTokenUsingJSONP:function(d,b){var f=this;return $.ajax({url:f.url+"/sessions/validate_token.json",dataType:"jsonp",data:{_method:"GET",token:d},success:function(d){if(d.error)throw console.log(d),d.error.data+" (from "+f.url+")";else b(d)}})}};typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/sail.rollcall.js");Sail=window.Sail||{};Sail.WiseXMPPAuthenticate={};Sail.WiseXMPPAuthenticate.Client=function(d){this.url=d};
Sail.WiseXMPPAuthenticate.Client.prototype={getCurrentToken:function(){return $.url.param("token")},redirectToLogin:function(){window.location.replace(this.url+"/login?destination="+escape(window.location.href))},fetchSessionForToken:function(d,b){currentUrl=$.url.attr("source");$.url.setUrl(this.url);wiseXMPPAuthenticateHost=$.url.attr("host");wiseXMPPAuthenticatePort=$.url.attr("port");wiseXMPPAuthenticateProtocol=$.url.attr("protocol");$.url.setUrl(currentUrl);wiseXMPPAuthenticateHost==$.url.attr("host")&&
wiseXMPPAuthenticatePort==$.url.attr("port")&&wiseXMPPAuthenticateProtocol==$.url.attr("protocol")?this.fetchSessionForTokenUsingREST(d,b):this.fetchSessionForTokenUsingJSONP(d,b)},fetchSessionForTokenUsingREST:function(d,b){var f=this;return $.ajax({url:f.url+"/sessions/validate_token.json",dataType:"json",data:{token:d},success:b,failure:function(b){console.log(b);throw"Error response from WiseXMPPAuthenticate at "+f.url;}})},fetchSessionForTokenUsingJSONP:function(d,b){var f=this;return $.ajax({url:f.url+
"/sessions/validate_token.json",dataType:"jsonp",data:{_method:"GET",token:d},success:function(d){if(d.error)throw console.log(d),d.error.data+" (from "+f.url+")";else b(d)}})},fetchXMPPAuthentication:function(d){return $.ajax({url:this.url,dataType:"json",success:d,failure:function(){console.log("Failed to Authenticate with XMPP")}})}};typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/sail.wiseauthenticate.js");Sail=window.Sail||{};
Sail.Strophe={bosh_url:null,jid:null,password:null,dataMode:"json",logLevel:Strophe.LogLevel.INFO,connect:function(){if(!this.bosh_url)throw"No bosh_url set!";if(!this.jid)throw"No jid set!";if(!this.password)throw"No password set!";this.conn=new Strophe.Connection(this.bosh_url);this.conn.xmlInput=function(){};this.conn.xmlOutput=function(){};this.conn.connect(this.jid,this.password,this.onConnect)},disconnect:function(){Sail.Strophe.conn.sync=!0;Sail.Strophe.conn.flush();Sail.Strophe.conn.disconnect()},addHandler:function(d,
b,f,g,n,c){if(!Sail.Strophe.conn)throw"Must connect before you can add handlers";Sail.Strophe.conn.addHandler(function(a){d(a);return!0},b,f,g,n,c)},pinger:function(d){d||(d=14E3);setInterval(function(){pres=$pres();Sail.Strophe.conn.send(pres.tree(),function(){},function(){});Sail.Strophe.conn.flush()},d)},onConnect:function(d){switch(d){case Strophe.Status.CONNECTED:$(window).unload(Sail.Strophe.disconnect);Sail.Strophe.addDefaultHandlers();Sail.Strophe.onConnectSuccess();Sail.Strophe.pinger();
break;case Strophe.Status.DISCONNECTED:Sail.Strophe.clearConnInfo()}},onConnectSuccess:function(){return!0},onGroupchatMessage:function(){return!0},onSuccess:function(){return!0},onFailure:function(){return!0},addDefaultHandlers:function(){Sail.Strophe.conn.addHandler(Sail.Strophe.errorHandler,null,null,"error")},errorHandler:function(d){err=$(d).children("error");errMsg=err.children("text").text();alert("XMPP ERROR: "+errMsg);return!0},log:function(d,b){switch(d){case Strophe.LogLevel.DEBUG:logFunc=
"debug";logMsg="DEBUG: "+b;break;case Strophe.LogLevel.INFO:logFunc="info";logMsg="INFO: "+b;break;case Strophe.LogLevel.WARN:logFunc="warn";logMsg="WARN: "+b;break;case Strophe.LogLevel.ERROR:logFunc="error";logMsg="ERROR: "+b;break;case Strophe.LogLevel.FATAL:logFunc="error";logMsg="FATAL: "+b;break;default:logFunc="log",logMsg=b}},storeConnInfo:function(){$.cookie("Sail.jid",Sail.Strophe.conn.jid);$.cookie("Sail.sid",Sail.Strophe.conn.sid);$.cookie("Sail.rid",Sail.Strophe.conn.rid)},retrieveConnInfo:function(){return{jid:$.cookie("Sail.jid"),
sid:$.cookie("Sail.sid"),rid:$.cookie("Sail.rid")}},clearConnInfo:function(){$.cookie("Sail.jid",null);$.cookie("Sail.sid",null);$.cookie("Sail.rid",null)},hasExistingConnInfo:function(){info=Sail.Strophe.retrieveConnInfo();return info.jid&&info.rid&&info.sid},reconnect:function(){if(!this.bosh_url)throw"No bosh_url set!";info=Sail.Strophe.retrieveConnInfo();this.conn=new Strophe.Connection(this.bosh_url);this.conn.attach(info.jid,info.sid,info.rid+1)}};
Sail.Strophe.Groupchat=function(d,b){this.room=d;this.conn=b||Sail.Strophe.conn;if(!this.conn)throw"No connection given for Groupchat!";};
Sail.Strophe.Groupchat.prototype={participants:[],join:function(){pres=$pres({to:this.jid()}).c("x",{xmlns:"http://jabber.org/protocol/muc"});this.conn.send(pres.tree());this.addDefaultPresenceHandlers()},jid:function(){return this.room+"/"+Sail.Strophe.jid},sendEvent:function(d){Sail.Strophe.dataMode=="json"?this.sendJSON(d.toJSON()):this.sendText(d)},sendXML:function(d){msg=$msg({to:this.room,type:"groupchat"}).c("body").cnode($(d)[0]);this.conn.send(msg.tree())},sendText:function(d){msg=$msg({to:this.room,
type:"groupchat"}).c("body").t(d);this.conn.send(msg.tree())},sendJSON:function(d){json_string=typeof d=="string"?d:JSON.stringify(d);msg=$msg({to:this.room,type:"groupchat"}).c("body").t(json_string);this.conn.send(msg.tree())},addHandler:function(d,b,f,g,n){if(!this.conn)throw"Must connect before you can add handlers";this.conn.addHandler(function(b){d(b);return!0},b,f,"groupchat",g,n)},addDefaultPresenceHandlers:function(){var d=this;this.conn.addHandler(function(b){if($(b).attr("type")!=null)return!0;
who=$(b).attr("from");d.participants.push(who);d.onParticipantJoin(who,b);return!0},null,"presence",null,null,d.room,{matchBare:!0});this.conn.addHandler(function(b){who=$(b).attr("from");d.participants.push(who);d.onParticipantLeave(who,b);return!0},null,"presence","unavailable",null,d.room,{matchBare:!0});this.conn.addHandler(function(b){if($(b).attr("type")!=null)return!0;d.onSelfJoin(b);return!0},null,"presence",null,null,d.jid());this.conn.addHandler(function(b){d.onSelfLeave(b);return!0},null,
"presence","unavailable",null,d.jid())},onParticipantJoin:function(){},onParticipantLeave:function(){},onSelfJoin:function(){},onSelfLeave:function(){},onMessage:function(){return!0}};Strophe.log=Sail.Strophe.log;typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/sail.strophe.js");WISE={wiseXMPPAuthenticateUrl:"",rollcallURL:"http://localhost:3000",xmppDomain:"localhost",groupchatRoom:"",groupchatRoomBase:"@conference.localhost",view:null,ui:Sail.UI,groupchat:null,session:null,justWatching:!1,init:function(d){view=d;console.log("Initializing WISE...");WISE.groupchatRoom=view.config.getConfigParam("runId")+WISE.groupchatRoomBase;console.log("chatroom:"+WISE.groupchatRoom);WISE.wiseXMPPAuthenticateUrl=view.config.getConfigParam("wiseXMPPAuthenticateUrl")+"&workgroupId="+view.userAndClassInfo.getWorkgroupId();
Sail.autobindEvents(WISE,{pre:function(){console.debug(arguments[0].type+"!",arguments)}});$("#pause-button").click(function(){WISE.doPause();return!1});$("#unPause-button").click(function(){WISE.doUnPause();return!1});$("#connecting").show();WISE.authenticate();return this},getJabberId:function(d){return d.split("/")[1].split("@")[0]},isEventFromTeacher:function(d){var d=d.from.split("/")[1].split("@")[0],b=view.getUserAndClassInfo().getTeacherWorkgroupId();return d==b},isEventFromStudent:function(){return!0},
doPause:function(){message=$("#pause-message").val();message==""&&$("#pause-message").val("Your teacher has paused your screen.");sev=new Sail.Event("pause",{message:message});WISE.groupchat.sendEvent(sev)},doUnPause:function(){sev=new Sail.Event("unPause");WISE.groupchat.sendEvent(sev)},authenticate:function(){WISE.wiseXMPPAuthenticate=new Sail.WiseXMPPAuthenticate.Client(WISE.wiseXMPPAuthenticateUrl);WISE.wiseXMPPAuthenticate.fetchXMPPAuthentication(function(d){WISE.xmppUsername=d.xmppUsername;
WISE.xmppPassword=d.xmppPassword;$(WISE).trigger("authenticated")})},disconnect:function(){this.doUnPause();Sail.Strophe.disconnect()},events:{sail:{pause:"pause",unPause:"unPause",studentToTeacherMsg:"studentToTeacherMsg",joinedGroupChat:"joinedGroupChat"},onAuthenticated:function(){Sail.Strophe.bosh_url="http://localhost/http-bind/";var d=(new Date).getTime();Sail.Strophe.jid=WISE.xmppUsername+"@"+WISE.xmppDomain+"/"+d;Sail.Strophe.password=WISE.xmppPassword;Sail.Strophe.onConnectSuccess=function(){sailHandler=
Sail.generateSailEventHandler(WISE);Sail.Strophe.addHandler(sailHandler,null,null,"groupchat");WISE.groupchat=new Sail.Strophe.Groupchat(WISE.groupchatRoom);WISE.groupchat.onParticipantJoin=function(b){b=WISE.getJabberId(b);$("#classroomMonitorWorkgroupRow_"+b).css("background-color","white")};WISE.groupchat.onParticipantLeave=function(b){b=WISE.getJabberId(b);$("#classroomMonitorWorkgroupRow_"+b).css("background-color","lightgrey")};WISE.groupchat.onSelfJoin=function(){console.log("onSelfJoinedGroupChat");
eventManager.fire("classroomMonitorDisplayComplete");$("#connecting").hide()};WISE.groupchat.join()};Sail.Strophe.connect()},onPause:function(d,b){WISE.isEventFromTeacher(b)&&($("#studentScreenStatus").html("paused"),$("#studentScreenStatus").css("color","red"))},onUnPause:function(d,b){WISE.isEventFromTeacher(b)&&($("#studentScreenStatus").html("unpaused"),$("#studentScreenStatus").css("color","green"))},onStudentToTeacherMsg:function(d,b){if(WISE.isEventFromStudent(b)){var f=b.payload,g=f.workgroupId;
if(f.type=="studentProgress"){var n=f.stepNumberAndTitle,c=f.projectCompletionPercentage;$("#teamCurrentStep_"+g).html(n);$("#teamPercentProjectCompleted_"+g).html(c+"%<hr size=3 color='black' width='"+c+"%' align='left' noshade>");$("#chooseTeamToGradeTable").trigger("update");var a=f.status;a!=null&&(a.maxAlertLevel>=0&&a.maxAlertLevel<2?$("#teamStatus_"+g).html("<img src='/vlewrapper/vle/images/check16.gif' />"):a.maxAlertLevel>=2&&a.maxAlertLevel<4?$("#teamStatus_"+g).html("warning"):a.maxAlertLevel>=
4&&$("#teamStatus_"+g).html("<img src='/vlewrapper/vle/images/warn16.gif' />"),$("#teamStatus_"+g).unbind("click"),$("#teamStatus_"+g).click(function(){for(var b="",c=0;c<a.alertables.length;c++){var d=a.alertables[c];d!=null&&d.readableText!=null&&(b+=d.stepNumberAndTitle+" ("+d.nodeType+")<br>",b+=d.readableText+"<br><br>")}$("#teamStatusDialog").html(b);$("#teamStatusDialog").dialog("open")}))}}}}};typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/teacher.js");Sail=window.Sail||{};
Sail.UI={init:function(){$(document).ready(function(){$("button, input[type=submit]").button();$(".dialog button").click(function(){Sail.UI.dismissDialog($(this).parents(".dialog"))})})},showDialog:function(d){dialogId="sail-dialog-"+Math.floor(Math.random()*1E11).toString(16);console.debug("Sail.UI: showing dialog "+dialogId);mask=$('<div class="mask"></div>');mask.addClass(dialogId);mask.insertBefore(d);mask.css("z-index",999);$(d).css("z-index",1E3);$(d).data("sail-dialog-id",dialogId);$(d).show()},
dismissDialog:function(d){$(d).length!=0&&(dialogId=$(d).data("sail-dialog-id"),console.debug("Sail.UI: dismissing dialog "+dialogId),$(".mask."+dialogId).remove(),$(d).fadeOut("fast"))}};typeof eventManager!="undefined"&&eventManager.fire("scriptLoaded","vle/xmpp/js/sail.js/sail.ui.js");
if(typeof eventManager != 'undefined'){eventManager.fire('scriptLoaded', 'vle/minified/teacherXMPP_min.js');}
