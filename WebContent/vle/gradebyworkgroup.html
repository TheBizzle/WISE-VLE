<html>
<head>
<title>Grade By Step</title>
<script type="text/javascript" src="js/sound/soundmanager/script/soundmanager2.js"></script>
<script type="text/javascript" src="js/sound/AudioManager.js"></script>
<script src="http://yui.yahooapis.com/3.0.0pr2/build/yui/yui-min.js" type="text/javascript"></script>


<!-- Dependency --> 
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/yahoo/yahoo-min.js" ></script>

<!-- Event source file -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/event/event-min.js" ></script>

<!-- Sam Skin CSS -->
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.7.0/build/container/assets/skins/sam/container.css">

<!-- Dependencies -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/yahoo-dom-event/yahoo-dom-event.js"></script>

<!-- OPTIONAL: Animation (only required if using ContainerEffect) -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/animation/animation-min.js"></script>

<!-- OPTIONAL: Drag & Drop (only required if enabling Drag & Drop) -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/dragdrop/dragdrop-min.js"></script>

<!-- Source file -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/container/container-min.js"></script>

<!-- Connection manager -->
<script src="http://yui.yahooapis.com/2.7.0/build/connection/connection-min.js"></script>


<script type="text/javascript" src="js/common/helperfunctions.js"></script>
<script type="text/javascript" src="js/VLE.js"></script>
<script type="text/javascript" src="js/contentpanel/ContentPanel.js"></script>
<script type="text/javascript" src="js/navigation/NavigationLogic.js"></script>
<script type="text/javascript" src="js/visibility/VisibilityLogic.js"></script>
<script type="text/javascript" src="js/visibility/OnlyShowSelectedNodes.js"></script>
<script type="text/javascript" src="js/visibility/CorrectnessBranchingVisibility.js"></script>
<script type="text/javascript" src="js/navigation/DFS.js"></script>
<script type="text/javascript" src="js/navigation/NavigationPanel.js"></script>
<script type="text/javascript" src="js/common/loadxmldoc.js"></script>
<script type="text/javascript" src="js/node/Node.js"></script>
<script type="text/javascript" src="js/node/HtmlNode.js"></script>
<script type="text/javascript" src="js/node/CustomNode.js"></script>
<script type="text/javascript" src="js/node/MatchSequenceNode.js"></script>
<script type="text/javascript" src="js/node/FillinNode.js"></script>
<script type="text/javascript" src="js/node/fillin/fillinstate.js"></script>
<script type="text/javascript" src="js/node/OpenResponseNode.js"></script>
<script type="text/javascript" src="js/node/NoteNode.js"></script>
<script type="text/javascript" src="js/node/openresponse/openresponse.js"></script>
<script type="text/javascript" src="js/node/openresponse/openresponsestate.js"></script>
<script type="text/javascript" src="js/node/JournalNode.js"></script>
<script type="text/javascript" src="js/node/OutsideUrlNode.js"></script>
<script type="text/javascript" src="js/node/BlueJNode.js"></script>
<script type="text/javascript" src="js/node/multiplechoice/multiplechoicestate.js"></script>
<script type="text/javascript" src="js/node/multiplechoice/mc.js"></script>
<script type="text/javascript" src="js/node/MultipleChoiceNode.js"></script>
<script type="text/javascript" src="js/node/multiplechoicecheckbox/mc_checkbox.js"></script>
<script type="text/javascript" src="js/node/multiplechoicecheckbox/multiplechoicecheckboxstate.js"></script>
<script type="text/javascript" src="js/node/MultipleChoiceCheckBoxNode.js"></script>
<script type="text/javascript" src="js/node/BrainstormNode.js"></script>
<script type="text/javascript" src="js/node/JournalEntryNode.js"></script>
<script type="text/javascript" src="js/node/TickerNode.js"></script>
<script type="text/javascript" src="js/project/Project.js"></script>
<script type="text/javascript" src="js/io/ConnectionManager.js"></script>
<script type="text/javascript" src="js/events/events.js"></script>
<script type="text/javascript" src="js/grading/Annotation.js"></script>
<script type="text/javascript" src="js/grading/Annotations.js"></script>

<!-- Ticker Query Files -->
<script type="text/javascript" src="js/node/ticker/ticker.js"></script>
<script type="text/javascript" src="js/node/QueryEntry.js"></script>
<script type="text/javascript" src="js/node/StudentWorkQueryObject.js"></script>
<script type="text/javascript" src="js/node/multiplechoice/MultipleChoiceQueryEntry.js"></script>
<script type="text/javascript" src="js/node/multiplechoice/MultipleChoiceQueryContainer.js"></script>
<script type="text/javascript" src="js/node/multiplechoicecheckbox/MultipleChoiceCheckBoxQueryEntry.js"></script>
<script type="text/javascript" src="js/node/multiplechoicecheckbox/MultipleChoiceCheckBoxQueryContainer.js"></script>

<script type="text/javascript" src="js/common/niftycube.js"></script>
<script type="text/javascript" src="js/navigation/menu.js"></script>

<script type="text/javascript" src="js/common/dropdown.js"></script>

<link rel="stylesheet" type="text/css" href="css/niftyCube.css" />
<link rel="stylesheet" type="text/css" href="css/navigation/testnavigation.css" />
<link rel="stylesheet" type="text/css" href="css/visibility/visibility.css" />
<link rel="stylesheet" type="text/css" href="css/navigation_mobile.css" />

<!--  no navigation styling for now
<link rel="stylesheet" type="text/css" href="css/sdmenu.css" />
 -->

<script type="text/javascript">
var vle = null;
var teacherWorkgroupId;
var studentWorkgroupId;
var getAnnotationsUrl;
var postAnnotationsUrl;
var studentInfoUrl;
var teacherInfoUrl;
var getStudentDataUrl;
var runId = null;
</script>

<!--  Javascript Pop up window -->

<script type="text/javascript">

var newWin = null;
function popUp(strURL, strType, strHeight, strWidth) {
 if (newWin != null && !newWin.closed)
   newWin.close();
 var strOptions="";
 if (strType=="console")
   strOptions="resizable,height="+
     strHeight+",width="+strWidth;
 if (strType=="fixed")
   strOptions="status,height="+
     strHeight+",width="+strWidth;
 if (strType=="elastic")
   strOptions="toolbar,menubar,scrollbars,"+
     "resizable,location,height="+
     strHeight+",width="+strWidth;
 newWin = window.open(strURL, 'newWin', strOptions);
 newWin.focus();
}

function load(contentUrl, studentInfoUrl, getDataUrl, contentBaseUrl, getAnnotationsUrl, postAnnotationsUrl, teacherInfoUrl, runId) {
	//create the VLE
	vle = new VLE();
	render(contentUrl, studentInfoUrl, getDataUrl, contentBaseUrl, getAnnotationsUrl, postAnnotationsUrl, teacherInfoUrl, runId);
}

/**
 * Posts the new or updated annotation back to the server and if that was 
 * successful, it will create a local Annotation object and place it in
 * our array of Annotations so our local copy is up to date
 */
function saveAnnotation(nodeId, toWorkgroup, fromWorkgroup, type, value, runId) {
	//alert("nodeId: " + nodeId + "\ntoWorkgroup: " + toWorkgroup + "\nfromWorkgroup: " + fromWorkgroup + "\ntype: " + type + "\nvalue: " + value);

	//build the post annotation url with get arguments
	var postAnnotationURL = postAnnotationsUrl + "?runId=" + runId + "&nodeId=" + nodeId + "&toWorkgroup=" + toWorkgroup + "&fromWorkgroup=" + fromWorkgroup + "&type=" + type + "&value=" + value;
	
	var postAnnotationCallback =
	{
		success: function(o) {
			/*
			 * if the post was successful it will be returned back to us
			 * and we will then create a local Annotation object so that
			 * our local array is up to date
			 */
			var annotation = Annotation.prototype.parseDataXML(o.responseXML);
			vle.annotations.addAnnotation(annotation);
		},
		failure: function(o) {
			alert('Error: Unable to load user info');
		},
		argument: ["a", "b", "c"],
		scope:this
	};

	//make the call to post the annotation
	var getUserTransaction = YAHOO.util.Connect.asyncRequest('GET', postAnnotationURL, postAnnotationCallback, null);
}

</script>

</head>

<body class=" yui-skin-sam">

<div id="gradeByWorkgroupDiv">

</div>
<script type="text/javascript">

function expandMenu(menuId) {
	myMenu.expandMenu(document.getElementById(menuId));
}

/**
 * Setup and display the project
 *
 * @param contentURL a url to the project file, we will use a get
 *		request to obtain the project file
 * @param userURL a url to the user info, we will use a get request
 *		to obtain the user info 
 */
function render(contentUrl, studentInfoUrl, getStudentDataUrl, contentBaseUrl, getAnnotationsUrl, postAnnotationsUrl, teacherInfoUrl, runId) {
	//alert('contentURL: ' + contentUrl + "\n\nstudentInfoUrl:" + studentInfoUrl + "\n\ngetDataUrl:" + getDataUrl + "\n\ncontentBaseUrl:" + contentBaseUrl + "\n\ngetAnnotationsUrl: " + getAnnotationsUrl + "\n\npostAnnotationsUrl: " + postAnnotationsUrl + "\n\nteacherInfoUrl: " + teacherInfoUrl);
	
	//remember urls will will require later
	this.postAnnotationsUrl = postAnnotationsUrl;
	this.getAnnotationsUrl = getAnnotationsUrl;
	this.studentInfoUrl = studentInfoUrl;
	this.teacherInfoUrl = teacherInfoUrl;
	this.getStudentDataUrl = getStudentDataUrl;
	this.runId = runId;

	//set the url to retreive the student data
	vle.getDataUrl = getStudentDataUrl;

	//load the project content
	vle.loadProject(contentUrl, contentBaseUrl);

	//make the request for the student user info and work data
	getStudentUserInfoAndData();

	/*
	 * have the getAnnotations function wait for the "learnerDataLoadingComplete" event
	 * before it starts rendering the grading view
	 */
	vle.eventManager.subscribe("learnerDataLoadingComplete", displayGradingView);

	//get the teacher user info
	getTeacherUserData();
}


/**
 * Retrieve the student's user info such as workgroupId
 */
function getStudentUserInfoAndData() {
	// fetch user data
	var userCallback = {
				success: function(o) {
					//parse the xml object to retrieve the student info
					//var studentInfo = USER_INFO.prototype.parseUserInfo(o.responseXML);

					//load the student info into the vle
					vle.loadUserAndClassInfo(o.responseXML);

					//load the student data
					vle.loadVLEState();

					//remember the student workgroupId
					studentWorkgroupId = vle.getWorkgroupId();
			  	},
				failure: function(o) {
					alert('Error: Unable to load user info');
				},
				argument: ["a", "b", "c"],
				scope:this
	};
	var getUserTransaction = YAHOO.util.Connect.asyncRequest('GET', studentInfoUrl, userCallback, null);
}

/**
 * Retrieve the teacher's user info such as workgroupId
 */
function getTeacherUserData() {
	// fetch user data
	var teacherCallback = {
				success: function(o) {
					//retrieve the teacher's workgroupId
					var teacherInfo = USER_INFO.prototype.parseUserInfo(o.responseXML);
					teacherWorkgroupId = teacherInfo.workgroupId;
			  	},
				failure: function(o) {
					alert('Error: Unable to load user info');
				},
				argument: ["a", "b", "c"],
				scope:this
	};
	var getTeacherTransaction = YAHOO.util.Connect.asyncRequest('GET', teacherInfoUrl, teacherCallback, null);
}

/**
 * Retreives the annotations and then creates the grading view
 */
function displayGradingView() {
	var annotationCallback = {
			success: function(o) {
				//parse the xml annotations object and set it into the vle
				vle.annotations = Annotations.prototype.parseDataXML(o.responseXML);

				//create the grading view and display it in the div
				document.getElementById("gradeByWorkgroupDiv").innerHTML = getGradeByWorkgroupHtml(vle.project.rootNode, vle.annotations);
		  	},
			failure: function(o) {
				alert('Error: Unable to load user info');
			},
			argument: ["a", "b", "c"],
			scope:this
	};
	var getUserTransaction = YAHOO.util.Connect.asyncRequest('GET', getAnnotationsUrl, annotationCallback, null);
}


/**
 * Generate the grading html view
 * @param node the node to generate html for (the first time this is passed
 *		 into this function, it will be the root node since this is a
 *		 recursive function)
 * @param annotations an array of annotations
 * @return the html grading view
 */
function getGradeByWorkgroupHtml(node, annotations) {
	var htmlSoFar = "";
	if (node.children.length > 0) {
		// this is a sequence node
		
		//loop through the children recursively
		for (var i = 0; i < node.children.length; i++) {
			//get the html generated by the child
			htmlSoFar += getGradeByWorkgroupHtml(node.children[i], annotations);
		}
	} else {
		// this is a leaf node
		htmlSoFar += "<h4>" + node.title + ": " + node.id + "</h4>";

	    htmlSoFar += "<table border='1'>";
	    htmlSoFar += "<tr><th>Work</th><th>Grading</th></tr>";
		htmlSoFar += "<tr><td>" + node.getShowAllWorkHtml(vle) + "</td>";

		var annotation = null;

		//get the latest annotation for this node if it exists
		if(annotations.getLatestAnnotationForNodeId(node.id) != null) {
			annotation = annotations.getLatestAnnotationForNodeId(node.id);
		}
		
		if(annotation != null) {
			//the annotation exists so we will populate the values from the annotation
			htmlSoFar += "<td><textarea rows='10' cols='10' id='annotationTextArea" + node.id + "'>" + annotation.value + "</textarea></td>";

			//add the save annotation button that will save the annotation to the db when clicked
			htmlSoFar += "<td><input type='button' name='submitAnnotation' value='Save Annotation' onClick='saveAnnotation(\"" + node.id + "\", \"" + annotation.toWorkgroup + "\", \"" + annotation.fromWorkgroup + "\", \"" + annotation.type + "\", document.getElementById(\"annotationTextArea" + node.id + "\").value, " + annotation.runId + ")'></td></tr>";
		} else {
			//the annotation does not exist so we will leave the text area blank
			htmlSoFar += "<td><textarea rows='10' cols='10' id='annotationTextArea" + node.id + "'></textarea></td>";

			//add the save annotation button that will save the annotation to the db when clicked
			htmlSoFar += "<td><input type='button' name='submitAnnotation' value='Save Annotation' onClick='saveAnnotation(\"" + node.id + "\", " + studentWorkgroupId + ", " + teacherWorkgroupId + ", \"comment\", document.getElementById(\"annotationTextArea" + node.id + "\").value, " + runId + ")'></td></tr>";
		}
		
		htmlSoFar += "</table>";
		htmlSoFar += "<br/><br/>";
	}
	return htmlSoFar;
}

var myMenu;

</script>
<div id="soundmanager-debug"></div>
</body>
</html>