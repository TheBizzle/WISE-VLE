<html>
<head>
<title>Grade By Step</title>
<script type="text/javascript" src="js/sound/soundmanager/script/soundmanager2.js"></script>
<script type="text/javascript" src="js/sound/AudioManager.js"></script>
<script src="http://yui.yahooapis.com/3.0.0pr2/build/yui/yui-min.js" type="text/javascript"></script>


<!-- Dependency --> 
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/yahoo/yahoo-min.js" ></script>

<!-- Event source file -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/event/event-min.js" ></script>

<!-- Sam Skin CSS -->
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.7.0/build/container/assets/skins/sam/container.css">

<!-- Dependencies -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/yahoo-dom-event/yahoo-dom-event.js"></script>

<!-- OPTIONAL: Animation (only required if using ContainerEffect) -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/animation/animation-min.js"></script>

<!-- OPTIONAL: Drag & Drop (only required if enabling Drag & Drop) -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/dragdrop/dragdrop-min.js"></script>

<!-- Source file -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/container/container-min.js"></script>

<!-- Connection manager -->
<script src="http://yui.yahooapis.com/2.7.0/build/connection/connection-min.js"></script>

<script type="text/javascript">
var vle = null;
</script>

<script type="text/javascript" src="js/common/helperfunctions.js"></script>
<script type="text/javascript" src="js/VLE.js"></script>
<script type="text/javascript" src="js/contentpanel/ContentPanel.js"></script>
<script type="text/javascript" src="js/navigation/NavigationLogic.js"></script>
<script type="text/javascript" src="js/visibility/VisibilityLogic.js"></script>
<script type="text/javascript" src="js/visibility/OnlyShowSelectedNodes.js"></script>
<script type="text/javascript" src="js/visibility/CorrectnessBranchingVisibility.js"></script>
<script type="text/javascript" src="js/navigation/DFS.js"></script>
<script type="text/javascript" src="js/navigation/NavigationPanel.js"></script>
<script type="text/javascript" src="js/common/loadxmldoc.js"></script>
<script type="text/javascript" src="js/node/Node.js"></script>
<script type="text/javascript" src="js/node/HtmlNode.js"></script>
<script type="text/javascript" src="js/node/CustomNode.js"></script>
<script type="text/javascript" src="js/node/MatchSequenceNode.js"></script>
<script type="text/javascript" src="js/node/FillinNode.js"></script>
<script type="text/javascript" src="js/node/fillin/fillinstate.js"></script>
<script type="text/javascript" src="js/node/OpenResponseNode.js"></script>
<script type="text/javascript" src="js/node/NoteNode.js"></script>
<script type="text/javascript" src="js/node/openresponse/openresponse.js"></script>
<script type="text/javascript" src="js/node/openresponse/openresponsestate.js"></script>
<script type="text/javascript" src="js/node/JournalNode.js"></script>
<script type="text/javascript" src="js/node/OutsideUrlNode.js"></script>
<script type="text/javascript" src="js/node/BlueJNode.js"></script>
<script type="text/javascript" src="js/node/multiplechoice/multiplechoicestate.js"></script>
<script type="text/javascript" src="js/node/multiplechoice/mc.js"></script>
<script type="text/javascript" src="js/node/MultipleChoiceNode.js"></script>
<script type="text/javascript" src="js/node/multiplechoicecheckbox/mc_checkbox.js"></script>
<script type="text/javascript" src="js/node/multiplechoicecheckbox/multiplechoicecheckboxstate.js"></script>
<script type="text/javascript" src="js/node/MultipleChoiceCheckBoxNode.js"></script>
<script type="text/javascript" src="js/node/BrainstormNode.js"></script>
<script type="text/javascript" src="js/node/JournalEntryNode.js"></script>
<script type="text/javascript" src="js/node/TickerNode.js"></script>
<script type="text/javascript" src="js/project/Project.js"></script>
<script type="text/javascript" src="js/io/ConnectionManager.js"></script>
<script type="text/javascript" src="js/events/events.js"></script>
<script type="text/javascript" src="js/grading/Annotation.js"></script>
<script type="text/javascript" src="js/grading/Annotations.js"></script>

<!-- Ticker Query Files -->
<script type="text/javascript" src="js/node/ticker/ticker.js"></script>
<script type="text/javascript" src="js/node/QueryEntry.js"></script>
<script type="text/javascript" src="js/node/StudentWorkQueryObject.js"></script>
<script type="text/javascript" src="js/node/multiplechoice/MultipleChoiceQueryEntry.js"></script>
<script type="text/javascript" src="js/node/multiplechoice/MultipleChoiceQueryContainer.js"></script>
<script type="text/javascript" src="js/node/multiplechoicecheckbox/MultipleChoiceCheckBoxQueryEntry.js"></script>
<script type="text/javascript" src="js/node/multiplechoicecheckbox/MultipleChoiceCheckBoxQueryContainer.js"></script>

<script type="text/javascript" src="js/common/niftycube.js"></script>
<script type="text/javascript" src="js/navigation/menu.js"></script>

<script type="text/javascript" src="js/common/dropdown.js"></script>

<link rel="stylesheet" type="text/css" href="css/niftyCube.css" />
<link rel="stylesheet" type="text/css" href="css/navigation/testnavigation.css" />
<link rel="stylesheet" type="text/css" href="css/visibility/visibility.css" />
<link rel="stylesheet" type="text/css" href="css/navigation_mobile.css" />

<!--  no navigation styling for now
<link rel="stylesheet" type="text/css" href="css/sdmenu.css" />
 -->

<script type="text/javascript">
var studentWorkQueryObject;

window.onload=function(){
Nifty("div#none","bottom");
Nifty("div#navigationBox","big");
Nifty("ul.toolsButtons a","transparent");
}

function projectSummary(){
	window.open("/webapp/student/vle/vle.html?runId=" + runId + "&summary=true", "Project Summary", "height=600, width=800");
};
</script>

<!--  Javascript Pop up window -->

<script type="text/javascript">
var contentUrl;
var userUrl;
var getDataUrl;
var teacherId;
var studentWorkgroupIds;
var vleStates;
var getAnnotationsUrl;
var postAnnotationsUrl;
var annotations;

var runId = null;
var newWin = null;
function popUp(strURL, strType, strHeight, strWidth) {
 if (newWin != null && !newWin.closed)
   newWin.close();
 var strOptions="";
 if (strType=="console")
   strOptions="resizable,height="+
     strHeight+",width="+strWidth;
 if (strType=="fixed")
   strOptions="status,height="+
     strHeight+",width="+strWidth;
 if (strType=="elastic")
   strOptions="toolbar,menubar,scrollbars,"+
     "resizable,location,height="+
     strHeight+",width="+strWidth;
 newWin = window.open(strURL, 'newWin', strOptions);
 newWin.focus();
}

function load(contentUrl, userUrl, getDataUrl, contentBaseUrl, getAnnotationsUrl, postAnnotationsUrl, runId) {
	//alert("contentURL: " + contentUrl + "\n\nuserURL: " + userUrl + "\n\ngetDataUrl: " + getDataUrl + "\n\ncontentBaseUrl: " + contentBaseUrl + "\n\ngetAnnotationsUrl: " + getAnnotationsUrl + "\n\npostAnnotationsUrl: " + postAnnotationsUrl);
	this.contentUrl = contentUrl;
	this.userUrl = userUrl;
	this.getDataUrl = getDataUrl;
	this.getAnnotationsUrl = getAnnotationsUrl;
	this.postAnnotationsUrl = postAnnotationsUrl; 
	this.runId = runId;
	
	render(contentUrl, userUrl, getDataUrl, contentBaseUrl, getAnnotationsUrl, postAnnotationsUrl, runId);
}

/**
 * Posts the new or updated annotation back to the server and if that was 
 * successful, it will create a local Annotation object and place it in
 * our array of Annotations so our local copy is up to date
 */
function saveAnnotation(nodeId, toWorkgroup, fromWorkgroup, type, value, runId) {
	//alert("nodeId: " + nodeId + "\ntoWorkgroup: " + toWorkgroup + "\nfromWorkgroup: " + fromWorkgroup + "\ntype: " + type + "\nvalue: " + value);

	//build the post annotation url with get arguments
	var postAnnotationURL = postAnnotationsUrl + "?runId=" + runId + "&nodeId=" + nodeId + "&toWorkgroup=" + toWorkgroup + "&fromWorkgroup=" + fromWorkgroup + "&type=" + type + "&value=" + value;
	
	var postAnnotationCallback =
	{
		success: function(o) {
			/*
			 * if the post was successful it will be returned back to us
			 * and we will then create a local Annotation object so that
			 * our local array is up to date
			 */
			var annotation = Annotation.prototype.parseDataXML(o.responseXML);
			annotations.addAnnotation(annotation);
		},
		failure: function(o) {
			alert('Error: Unable to load user info');
		},
		argument: ["a", "b", "c"],
		scope:this
	};

	//make the call to post the annotation
	var getUserTransaction = YAHOO.util.Connect.asyncRequest('GET', postAnnotationURL, postAnnotationCallback, null);
}

</script>

</head>

<body class=" yui-skin-sam">

<div id="gradeByStepDiv"></div>

<script type="text/javascript">

function expandMenu(menuId) {
	myMenu.expandMenu(document.getElementById(menuId));
}

/**
 * Setup and display the project
 *
 * @param contentURL a url to the project file, we will use a get
 *		request to obtain the project file
 * @param userURL a url to the user info, we will use a get request
 *		to obtain the user info 
 */
function render(contentURL, userURL, getDataUrl, contentBaseUrl, getAnnotationsUrl, postAnnotationsUrl, runId) {
	vle = new VLE();

	//load the project content
	vle.loadProject(contentUrl, contentBaseUrl);

	//retrieve the workgroup ids for the students
	getStudentUserInfo();

	//setup events
	vle.eventManager.addEvent(vle, 'getStudentUserInfoComplete');
	vle.eventManager.addEvent(vle, 'getStudentWorkComplete');

	/*
	 * when we are done retrieving the student workgroup ids, we will
	 * retrieve the work from all the students
	 */
	vle.eventManager.subscribe("getStudentUserInfoComplete", getStudentWork);

	/*
	 * when we are done retrieving the student work, we will retrieve
	 * the annotations
	 */
	vle.eventManager.subscribe("getStudentWorkComplete", getAnnotations);
}

/**
 * Retrieve the student workgroupIds
 */
function getStudentUserInfo() {
	var studentWorkCallback = {
			success: function(o) {
				//parse and load the xml that contains the workgroup ids
				vle.loadUserAndClassInfo(o.responseXML);

				//get the teacher workgroup id
				teacherId = vle.getWorkgroupId();

				//retrieve all the student users
				studentWorkgroupIds = new Array();
				classUsers = vle.getClassUsers();

				//loop through all the classmates
				for(var x=0; x<classUsers.length; x++) {
					//all users including the teacher are stored as a classmate right now
					if(classUsers[x].workgroupId != teacherId) {
						/*
						 * if the user is not the teacher, add it to the 
						 * student workgroup ids array
						 */
						studentWorkgroupIds.push(classUsers[x].workgroupId);
					}
				}

				//fire this event to notify others that we are done getting the student workgroup ids
				vle.eventManager.fire("getStudentUserInfoComplete");
			},
			failure: function(o) {
				alert("Failed to load student work");
			},
			argument: ["a", "b", "c"],
			scope:this
	};
	YAHOO.util.Connect.asyncRequest('GET', userUrl, studentWorkCallback);
		
}

/**
 * This should only be called after getStudentUserInfo() has been called.
 * This just appends all the student workgroup ids together seperated by :
 * e.g.
 * 139:143:152
 * @return a string containing the student workgroup ids delimited by :
 */
function getStudentWorkgoupIds() {
	var ids = "";

	//loop through all the student workgroup ids
	for(var x=0; x<studentWorkgroupIds.length; x++) {
		if(ids != "") {
			/*
			 * if this is not the first workgroup id, we need to seperate
			 * it from the previous id with a :
			 */
			ids += ":";
		}
		ids += studentWorkgroupIds[x];
	}
	return ids;
}

/**
 * Retrieve the student work from the db
 */
function getStudentWork() {
	var getStudentDataUrl = getDataUrl + "?userId=" + getStudentWorkgoupIds();
	var studentWorkCallback = {
			success: function(o) {
				var xmlObject = o.responseXML;

				//parse all the vlestates for all the students
				vleStates = VLE_STATE.prototype.parseVLEStatesDataXMLObject(xmlObject);

				/*
				 * display links for all the steps so the user can click on a
				 * link and see everyone's work for that step
				 */
				displaySteps();

				//fire the event to nofity others that we are done getting the student work
				vle.eventManager.fire("getStudentWorkComplete");
			},
			failure: function(o) {
				alert("Failed to load student work");
			},
			argument: ["a", "b", "c"],
			scope:this
	};
	YAHOO.util.Connect.asyncRequest('GET', getStudentDataUrl, studentWorkCallback);
}

/**
 * Retrieve all the annotations for this run
 */
function getAnnotations() {
	var annotationCallback = {
			success: function(o) {
				//parse the xml annotations object that contains all the annotations
				annotations = Annotations.prototype.parseDataXML(o.responseXML);
		  	},
			failure: function(o) {
				alert('Error: Unable to load user info');
			},
			argument: ["a", "b", "c"],
			scope:this
	};
	var getUserTransaction = YAHOO.util.Connect.asyncRequest('GET', getAnnotationsUrl, annotationCallback, null);
}

/**
 * Displays all the steps in the project as links. When a step is clicked on,
 * the user will be brought to a page that displays all the work for that
 * step from all students in the run.
 */
function displaySteps() {
	var displayStepsHtml = "";

	//retrieve all the nodeIds
	var nodeIds = vle.getLeafNodeIds();

	/*
	 * loop through all the nodeIds and create a link for each, each link will
	 * bring the user to the grading page for that step/node
	 */
	for(var x=0; x<nodeIds.length; x++) {
		displayStepsHtml += "<a href='#' onClick='getGradeByStepHtml(\"" + nodeIds[x] + "\")'>" + nodeIds[x] + "</a>";
		displayStepsHtml += "<br><br>";
	}

	//set the html in the div so the user can see it
	document.getElementById('gradeByStepDiv').innerHTML = displayStepsHtml;
}

/**
 * Displays the grading view for a step which includes all the student ids,
 * student work, and grading text box
 * @param nodeId the step to display the grading view for
 */
function getGradeByStepHtml(nodeId) {
	var gradeByStepHtml = "";

	/*
	 * add the button that allows the user to get back to the screen to choose
	 * the step
	 */
	gradeByStepHtml += "<input type='button' value='Go Back to Steps' onClick='displaySteps()'>";

	//create the table that displays all the student data, student work, and grading text box
	gradeByStepHtml += "<table border='1'";

	//add the header for the table
	gradeByStepHtml += "<tr><th>Workgroup Id</th><th>Work</th><th>Grading</th></tr>";

	//loop through all the vleStates, each vleState is for a workgroup
	for(var x=0; x<vleStates.length; x++) {
		//get a vleState
		var vleState = vleStates[x];

		var studentWork = "";

		//get the latest node visit for the given nodeId
		var latestNodeVisit = vleState.getLatestNodeVisitByNodeId(nodeId);

		//check if there was a node visit and if that had node states
		if(latestNodeVisit != null && latestNodeVisit.nodeStates != null) {
			if(latestNodeVisit.nodeStates.length != 0) {
				//if there were node states, we will retrieve the last state to display the student work from it
				studentWork = latestNodeVisit.nodeStates[latestNodeVisit.nodeStates.length - 1].getStudentWork();
			}                            			
		}

		var annotation = null;

		//get the latest annotation for this node, studentWorkgroupId, and teacherId if it exists
		if(annotations.getLatestAnnotationByNodeIdAndToWorkgroupAndFromWorkgroup(nodeId, vleState.dataId, teacherId) != null) {
			annotation = annotations.getLatestAnnotationByNodeIdAndToWorkgroupAndFromWorkgroup(nodeId, vleState.dataId, teacherId);
		}

		gradeByStepHtml += "<tr>";

		//display the student workgroup id
		gradeByStepHtml += "<td>" + vleState.dataId + "</td>";

		//display the student work for this step/node
		gradeByStepHtml += "<td>" + studentWork + "</td>";

		/*
		 * display the grading text box and save annotation button
		 */
		if(annotation != null) {
			//the annotation exists so we will populate the values from the annotation
			gradeByStepHtml += "<td><textarea rows='10' cols='10' id='annotationTextArea" + vleState.dataId + "'>" + annotation.value + "</textarea></td>";

			//add the save annotation button that will save the annotation to the db when clicked
			gradeByStepHtml += "<td><input type='button' name='submitAnnotation' value='Save Annotation' onClick='saveAnnotation(\"" + nodeId + "\", \"" + annotation.toWorkgroup + "\", \"" + annotation.fromWorkgroup + "\", \"" + annotation.type + "\", document.getElementById(\"annotationTextArea" + vleState.dataId + "\").value, " + annotation.runId + ")'></td></tr>";
		} else {
			//the annotation does not exist so we will leave the text area blank
			gradeByStepHtml += "<td><textarea rows='10' cols='10' id='annotationTextArea" + vleState.dataId + "'></textarea></td>";

			//add the save annotation button that will save the annotation to the db when clicked
			gradeByStepHtml += "<td><input type='button' name='submitAnnotation' value='Save Annotation' onClick='saveAnnotation(\"" + nodeId + "\", " + vleState.dataId + ", " + teacherId + ", \"comment\", document.getElementById(\"annotationTextArea" + vleState.dataId + "\").value, " + runId + ")'></td></tr>";
		}
		

		gradeByStepHtml += "</tr>";
	}

	gradeByStepHtml += "</table>";

	//set the html in the div so the user can see it
	document.getElementById('gradeByStepDiv').innerHTML = gradeByStepHtml;
}

var myMenu;


</script>
<div id="soundmanager-debug"></div>
</body>
</html>