<!-- @author: patrick lawler -->
<html>
<head>

<!-- Dependency --> 
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/yahoo/yahoo-min.js" ></script>

<!-- Event source file -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/event/event-min.js" ></script>

<!-- Sam Skin CSS -->
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.7.0/build/container/assets/skins/sam/container.css">

<!-- Dependencies -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/yahoo-dom-event/yahoo-dom-event.js"></script>

<!-- OPTIONAL: Animation (only required if using ContainerEffect) -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/animation/animation-min.js"></script>

<!-- OPTIONAL: Drag & Drop (only required if enabling Drag & Drop) -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/dragdrop/dragdrop-min.js"></script>

<!-- Source file -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/container/container-min.js"></script>

<!-- Connection manager -->
<script src="http://yui.yahooapis.com/2.7.0/build/connection/connection-min.js"></script>

<script type="text/javascript" src="../js/common/loadxmldoc.js"></script>
<script type="text/javascript" src="../js/common/helperfunctions.js"></script>
<script type="text/javascript" src="../js/node/Node.js"></script>
<script type="text/javascript" src="../js/node/MultipleChoiceNode.js"></script>

<script type="text/javascript" src="../js/node/multiplechoice/multiplechoicestate.js"></script>
<script type="text/javascript" src="../js/node/multiplechoice/mc.js"></script>

<script type="text/javascript">
var xmlPage;
var saved = true;

function getSaved(){
	return saved;
};

function generatePage(){
	var parent = document.getElementById('dynamicParent');
	
	//wipe out old
	parent.removeChild(document.getElementById('dynamicPage'));
	
	//create new
	var pageDiv = createElement(document, 'div', {id:'dynamicPage'});
	var promptText = document.createTextNode("Enter/Edit prompt text: ");
	var linesText = document.createTextNode("Enter expected number of lines for response: ");
	
	pageDiv.appendChild(linesText);
	pageDiv.appendChild(createBreak());
	pageDiv.appendChild(generateLines());
	pageDiv.appendChild(createBreak());
	pageDiv.appendChild(createBreak());
	pageDiv.appendChild(promptText);
	pageDiv.appendChild(createBreak());
	pageDiv.appendChild(generatePrompt());
	
	parent.appendChild(pageDiv);
};

function generateLines(){
	var lines = createElement(document, 'input', {type: 'text', id: 'linesInput', value: xmlPage.getElementsByTagName('extendedTextInteraction')[0].getAttribute('expectedLines')});
	return lines;
};

function generatePrompt(){
	var prompt = createElement(document, 'textarea', {id: 'promptInput', name: 'promptInput', cols: '50', rows: '6', wrap: 'hard', onkeyup: "sourceUpdated()"});
	if(xmlPage.getElementsByTagName('prompt')[0].firstChild){
		prompt.value = xmlPage.getElementsByTagName('prompt')[0].firstChild.nodeValue;
	} else {
		prompt.value = "";
	};
	return prompt;
};

function updateXMLPage(){
	var parent = xmlPage.getElementsByTagName('extendedTextInteraction')[0];
	var pagePrompt = xmlPage.createElement('prompt');
	var pagePromptText = xmlPage.createTextNode(document.getElementById('promptInput').value);
	
	parent.setAttribute('expectedLines', document.getElementById('linesInput').value);
	pagePrompt.appendChild(pagePromptText);
	parent.appendChild(pagePrompt);
};

/**
 * returns a <br> element
 */
function createBreak(){
	return createElement(document, 'br', null);
};

function save(){
	var htmlString;
	
	if(window.ActiveXObject) {
		htmlString = xmlPage.xml;
	} else {
		htmlString = (new XMLSerializer()).serializeToString(xmlPage);
	};
	
	var callback = {
		success: function(o){
			saved = true;
			if(o.responseText!='success'){
				alert('Failed save to server');
			};
		},
		failure: function(o){alert('Unable to save file to server');},
		scope:this
	};
	
	YAHOO.util.Connect.asyncRequest('POST', '../../filemanager.html', callback, 'command=updateFile&param1=' + parent.projectName + '&param2=' + parent.filename + '&param3=' + encodeString(htmlString));
};

/**
 * Load the authoring view from the specified filename
 * filename points to a plain old file.
 */
function loadAuthoringFromFile(filename, projectName) {
	var callback =
	{
	  success: function(o) { 
	  var xmlDocToParse = o.responseXML;

		  /***						***|
		   * Extra work needed for IE *|
		   ***						***/
		  if(window.ActiveXObject){
		  	var ieXML = new ActiveXObject("Microsoft.XMLDOM");
		  	ieXML.async = "false";
		  	ieXML.loadXML(o.responseText);
		  	xmlDocToParse = ieXML;
		  };
		  /***						***|
		   * End extra work for IE	  *|
		   ***						***/
	
		/**
		 * sets local xml and then generates the left panel
		 * of this page dynamically
		 */
		xmlPage = xmlDocToParse;
		generatePage();	
	
		//retrieve the xmlString from the mcObj
		var xmlString = "";
		if(window.ActiveXObject) {
			xmlString = xmlDocToParse.xml;
		} else {
			xmlString = (new XMLSerializer()).serializeToString(xmlDocToParse);
		}

		window.frames["previewFrame"].renderORFromString(xmlString);

		  },
		  failure: function(o) { alert('failure');},
		  scope: this
	}

	YAHOO.util.Connect.asyncRequest('POST', '../../filemanager.html', callback, 'command=retrieveFile&param1=' + projectName + '&param2=' + filename);
}

/*
 * Called when 'keyup' event is received on sourceTextArea on this page.
 * gets the text in the textarea and re-renders the previewFrame
 */
function sourceUpdated() {
	saved = false;
	//retrieve the authored text
	//var xmlString = document.getElementById('sourceTextArea').value;
	var parent = xmlPage.getElementsByTagName('extendedTextInteraction')[0];
	parent.removeChild(xmlPage.getElementsByTagName('prompt')[0]);
	
	updateXMLPage();
	
	var xmlString;
	if(window.ActiveXObject) {
		xmlString = xmlPage.xml;
	} else {
		xmlString = (new XMLSerializer()).serializeToString(xmlPage);
	}
	
	window.frames["previewFrame"].renderORFromString(xmlString);
}

function loaded(){
	if(window.parent){
		loadAuthoringFromFile(window.parent.filename, window.parent.projectName);
		window.parent.childSave = save;
		window.parent.getSaved = getSaved;
	};
};
</script>
</head>
<body onload="loaded()">
<table border='1' bgcolor='white' style='width:100%;height:100%'>
	<tr>
		<td width='50%' id="dynamicParent"><div id="dynamicPage"></div></td>
		<td width='50%'><iframe id='previewFrame' width='100%' height='100%' name='previewFrame' src='../js/node/openresponse/openresponse_plain.html'></iframe></td>
	</tr>
</table>
<!--  for posting the text for echo servlet -->
<form name="saveLocal" id='saveLocal' action="../../echo.html" method="POST">
    <input type="hidden" name="name" id="form_filename" value="myData"/>
    <input type="hidden" name="data" id="localData" value=""/>
</form>
</body>
</html>