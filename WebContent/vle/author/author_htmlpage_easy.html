<html>
<head>

<!-- Dependency --> 
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/yahoo/yahoo-min.js" ></script>

<!-- Event source file -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/event/event-min.js" ></script>

<!-- Sam Skin CSS -->
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.7.0/build/container/assets/skins/sam/container.css">

<!-- Dependencies -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/yahoo-dom-event/yahoo-dom-event.js"></script>

<!-- OPTIONAL: Animation (only required if using ContainerEffect) -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/animation/animation-min.js"></script>

<!-- OPTIONAL: Drag & Drop (only required if enabling Drag & Drop) -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/dragdrop/dragdrop-min.js"></script>

<!-- Source file -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/container/container-min.js"></script>

<!-- Connection manager -->
<script src="http://yui.yahooapis.com/2.7.0/build/connection/connection-min.js"></script>

<script type="text/javascript" src="../js/common/loadxmldoc.js"></script>
<script type="text/javascript" src="../js/common/helperfunctions.js"></script>
<script type="text/javascript" src="../js/node/Node.js"></script>
<script type="text/javascript" src="../js/node/HtmlNode.js"></script>

<script type="text/javascript">
var node; //an HtmlNode
var thisFilename = null;

function save() {
	  if(confirm("Saving locally requires a file download. If you do not wish to do this, cancel now! Otherwise, click OK.")){
		  var htmlString = document.getElementById('sourceTextArea').value;
	      document.getElementById('localData').value = htmlString;
	      if (thisFilename != null) {
	      	document.getElementById('form_filename').value = thisFilename;
	      }
	      document.getElementById('saveLocal').submit();
	   };
}

/*
 * Called by this page's Body.onload
 */
function authoringPageLoaded() {
	if (opener) {
		//alert('opener exists, calling its authoring_window loaded function');
		//alert(opener);
		if (opener.filenameToAuthor) {
			//alert('opener.filenameToAuthor exists, it is: ' + opener.filenameToAuthor);
			loadAuthoringFromFile(opener.filenameToAuthor);
		}
		opener.authoringWindowLoaded();
	} else {
		alert('parent does not exist, loading default page');
		loadAuthoringFromFile('../testproject/a2s1.html');
	}
}

/**
 * Load the html authoring view from the specified filename
 * filename points to a plain old html file.
 */
function loadAuthoringFromFile(filename) {
	thisFilename = filename
	var callback =
	{
	  success: function(o) { 
		  var xmlDocObj = new LoadXMLDocObj();
		  xmlDocObj.xmlDoc = o.responseXML;   // o.responseXML is the OTML
		  //alert(o.responseXML);
		  htmlContent = o.responseText;
		  var xmlDocToParse = o.responseXML;
		  /*
		  if (o.responseXML.getElementsByTagName("OTPasActivity").length == 0) {
			  // WINDOWS IE
			  //alert(o.responseText);
			  var windowsXMLDoc = new ActiveXObject("Microsoft.XMLDOM");
			  windowsXMLDoc.async = "false";
			  windowsXMLDoc.loadXML(o.responseText);
			  xmlDocToParse = windowsXMLDoc;
			  //alert('done');
			  //alert(xmlDocToParse);
			  //alert('done done');
		  }	
		  */	  
		  node = new HtmlNode();
		  node.setContent(htmlContent);
		  document.getElementById('sourceTextArea').value = htmlContent;
		  window.frames["previewFrame"].document.open();
		  window.frames["previewFrame"].document.write(htmlContent);
		  window.frames["previewFrame"].document.close();
		  //htmlNode.render(window.frames["previewFrame"]);
	  },
	  failure: function(o) { alert('failure');},
	  argument: ["a", "b", "c"]
	}

	// fetch the file
	var transaction = YAHOO.util.Connect.asyncRequest('GET', filename, callback, null);
}

function previewFrameOnLoad() {
	//nothing needs to be done here right now 
}	

/*
 * This is called by the authoring_tool.html after it has
 * set the node.
 */
function loadAuthoring() {
	if(node != null) {
		//tell the node to render itself in the previewFrame right iframe
		node.render(window.frames["previewFrame"]);

		//set the text in the left text area to contain the html from the node
		document.getElementById('sourceTextArea').value = node.content;
	}
}

/*
 * 
 */
function afterAuthoringLoaded() {
	//nothing needs to be done here right now
}

/*
 * Called to send the authored text back to the previewFrame so the
 * previewFrame can update itself and reflect the changes the author
 * has made.
 */
function sourceUpdated() {
	//retrieve the authored text
	var htmlString = document.getElementById('sourceTextArea').value;

	//set the authored html into the HtmlNode
	node.setContent(htmlString);

	//tell the node to render itself in the previewFrame iframe
	node.render(window.frames["previewFrame"]);
}

function loaded(){
	if(window.parent){
		loadAuthoringFromFile(window.parent.filename);
		window.parent.childSave = save;
	};
};
</script>
</head>
<body onload="loaded();">
<table border='1' bgcolor='white' style='width:100%;height:100%'>
	<tr>
   		<td width='50%'><textarea id='sourceTextArea' style='width:100%;height:100%' onkeyup='sourceUpdated();'></textarea></td>
   		<td width='50%'><iframe id='previewFrame' width='100%' height='100%' name='previewFrame' onload='previewFrameOnLoad();'></iframe></td>
	</tr>
</table>
<!--  for posting the text for echo servlet -->
<form name="saveLocal" id='saveLocal' action="../../echo.html" method="POST">
    <input type="hidden" name="name" id="form_filename" value="myData"/>
    <input type="hidden" name="data" id="localData" value=""/>
</form>
</body>
</html>