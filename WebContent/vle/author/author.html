<head>
<script type="text/javascript" src="../js/sound/soundmanager/script/soundmanager2.js"></script>
<script type="text/javascript" src="../js/sound/AudioManager.js"></script>

<!-- Dependency --> 
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/yahoo/yahoo-min.js" ></script>

<!-- Event source file -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/event/event-min.js" ></script>

<!-- Sam Skin CSS -->
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.7.0/build/container/assets/skins/sam/container.css">

<!-- Dependencies -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/yahoo-dom-event/yahoo-dom-event.js"></script>

<!-- OPTIONAL: Animation (only required if using ContainerEffect) -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/animation/animation-min.js"></script>

<!-- OPTIONAL: Drag & Drop (only required if enabling Drag & Drop) -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/dragdrop/dragdrop-min.js"></script>

<!-- Source file -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/container/container-min.js"></script>

<!-- Connection manager -->
<script src="http://yui.yahooapis.com/2.7.0/build/connection/connection-min.js"></script>

<script src="http://yui.yahooapis.com/3.0.0pr2/build/yui/yui-min.js" type="text/javascript"></script>
<!-- <script type="text/javascript" src="../js/authoring/AuthoringTool.js"></script>    -->
<script type="text/javascript" src="../js/authoring/authoring.js"></script>
<script type="text/javascript" src="../js/authoring/newauthoring.js"></script>
<script type="text/javascript" src="../js/common/helperfunctions.js"></script>
<script type="text/javascript" src="../js//VLE.js"></script>
<script type="text/javascript" src="../js/contentpanel/ContentPanel.js"></script>
<script type="text/javascript" src="../js/navigation/NavigationLogic.js"></script>
<script type="text/javascript" src="../js/navigation/DFS.js"></script>
<script type="text/javascript" src="../js/navigation/NavigationPanel.js"></script>
<script type="text/javascript" src="../js/common/loadxmldoc.js"></script>
<script type="text/javascript" src="../js/node/Node.js"></script>
<script type="text/javascript" src="../js/node/HtmlNode.js"></script>
<script type="text/javascript" src="../js/node/CustomNode.js"></script>
<script type="text/javascript" src="../js/node/MatchSequenceNode.js"></script>
<script type="text/javascript" src="../js/node/FillinNode.js"></script>
<script type="text/javascript" src="../js/node/NoteNode.js"></script>
<script type="text/javascript" src="../js/node/JournalNode.js"></script>
<script type="text/javascript" src="../js/node/JournalEntryNode.js"></script>
<script type="text/javascript" src="../js/node/OutsideUrlNode.js"></script>
<script type="text/javascript" src="../js/node/BlueJNode.js"></script>
<script type="text/javascript" src="../js/node/MultipleChoiceNode.js"></script>
<script type="text/javascript" src="../js/node/BrainstormNode.js"></script>
<script type="text/javascript" src="../js/project/Project.js"></script>
<script type="text/javascript" src="../js/io/ConnectionManager.js"></script>

<script type="text/javascript" src="../js/common/niftycube.js"></script>
<script type="text/javascript" src="../js/common/sdmenu.js"></script>
<script type="text/javascript" src="../js/common/dropdown.js"></script>

<link rel="stylesheet" type="text/css" href="../css/authoring/authoring.css" />
<link rel="stylesheet" type="text/css" href="../css/niftyCube.css" />
<link rel="stylesheet" type="text/css" href="../css/navigation.css" />
<link rel="stylesheet" type="text/css" href="../css/sdmenu.css" />

<link rel="shortcut icon" href="../images/favicon_panda.ico">


<script type='text/javascript'>
var project;
var easyMode = true; //the mode that gets passed to the individual authoring pages
var htmlPageName; //the root name of the html that gets passed to the individual authoring pages
var currentProjectName;

//a string that temporarily contains the node id we want to author
var nodeIdToAuthor = null;

// a string that temporarily contains the filename that we want to author
var filenameToAuthor = null;

// filename of this project (not page/step), should end with .project
var thisFilename = null;

var ddList = [];  // list of all draggable nodes
var targets = [];

//var authoringTool = new AuthoringTool();

/*****											    *****|
 * The following functions are used by YUI for the drag *|
 * and drop stuff on this page						    *|
 *****											    *****/
//function generateDD(){
//	ddList = [];
//	targets = [];
//}; 

function createTargets(){
	var target = new YAHOO.util.DDTarget(document.getElementById('projectDiv'), 'project');
	targets.push(target);
	
	var sequences = document.getElementsByName('sequenceContainer');
	for(var h=0;h<sequences.length;h++){
		target = new YAHOO.util.DDTarget(sequences[h], 'sequences');
		targets.push(target);
	};
	
	target = new YAHOO.util.DDTarget(document.getElementById('allNodesDiv'), 'nodes');
	targets.push(target);
};

function createDraggables(){
	var sequences = document.getElementsByName('sequences');
	for(var z=0;z<sequences.length;z++){
		var dd = new YAHOO.util.DDProxy(sequences[z], 'sequences');
		dd.addToGroup('project');
		ddList.push(dd);
	};
	
	var nodes = document.getElementsByName('nodes');
	for(var w=0;w<nodes.length;w++){
		var dd = new YAHOO.util.DDProxy(nodes[w], 'sequences');
		dd.addToGroup('nodes');
		ddList.push(dd);
	};
};
/*****												******|
 * End functions used by YUI for the drag and drop stuff *|
 *****												******/
function save() {
	  if(confirm("Saving locally requires a file download. If you do not wish to do this, cancel now! Otherwise, click OK.")){
		  var projectString = project.generateProjectFileString();
	      document.getElementById('localData').value = projectString;
	      if (thisFilename != null) {
	      	document.getElementById('form_filename').value = thisFilename;
	      }
	      document.getElementById('saveLocal').submit();
	   };
}

function preview() {
	if(currentProjectName){
		popupPreviewWindow('preview.html', 'PreviewWindow');
	} else {
		alert('Please open or create a new project to preview. Exiting...');
	};
};

/*
 * This is called onload of the 'authoringFrame' iframe
 */
function authoringFrameOnLoad() {
	/*
	 * if project is null, it means this is the first time this page has been
	 * loaded and also the first time the authoringFrame iframe has been
	 * loaded so the project has not been loaded yet. This is ok, we only
	 * need this function to set the node after the user has clicked on a
	 * step.
	 */
	if(project != null) {
		//pass the node that we're going to author to the authoringFrame
		window.frames["authoringFrame"].node = project.rootNode.getNodeById(nodeIdToAuthor);

		/*
		 * call load on the html page that is in the authoringFrame
		 * so that the page in the authoringFrame can do what it needs to
		 * do with the node we just gave it above
		 */
		window.frames["authoringFrame"].loadAuthoring();
	}
}

/*
 * Remembers the nodeId we currently want to author in a global variable so we
 * can call project.rootNode.getNodeById(nodeIdToAuthor) later to retrieve
 * the node. nodeId is a string.
 */
function setNodeToAuthor(nodeId) {
	/*
	 * sets the node to be authored so later in authoringFrameLoaded()
	 * we know which node to pass to the authoringFrame
	 */
	nodeIdToAuthor = nodeId;
}

function openProject(){
	window.open("openproject.html", "Open Project", "toolbar=no,width=500,height=350,menubar=no");
};

function createNewProject(){
	window.open("createproject.html", "Create Project", "toolbar=no,width=500,height=350,menubar=no");
};

function createNewSequence(){
	if(currentProjectName){
		window.open("createsequence.html", "Create Sequence", "toolbar=no,width=500,height=350,menubar=no");
	} else {
		alert('Please open or create a new project before creating a sequence. Exiting...');
	};
};

function createNewNode(){
	if(currentProjectName){
		window.open("createnode.html", "Create Node", "toolbar=no,width=500,height=350,menubar=no");
	} else {
		alert('Please open or create a new project before creating a node. Exiting...');
	};
};

function editProjectFile(){
	if(currentProjectName){
		window.open('editprojectfile.html', 'Edit Project', "toolbar=no,width=800,height=600,menubar=no");
	} else {
		alert('Please open or create a new project before editing the project file. Exiting...');
	};
};

function loadProjectFromServer(projectName){
	currentProjectName = projectName;
	var callback =
	{
		success: function(o) {
		  var xmlDocToParse = o.responseXML;
		  project = new Project(xmlDocToParse);
		  
		  project.xmlDoc = xmlDocToParse;
		  vle = new VLE();
		  vle.setProject(project);
		  var dfs = new DFS(project.rootNode);
		  vle.navigationLogic = new NavigationLogic(dfs);
		  vle.setConnection(new ConnectionManager());
		 
          displayProject(project);
          document.getElementById('currentProject').innerHTML = '<h3>Current Project: ' + projectName + '</h3>';
	  },			
	  failure: function(o) { alert('unable to retrieve project from server');},
	  scope:this
	}
	var transaction = YAHOO.util.Connect.asyncRequest('POST', '../../filemanager.html', callback, 'command=retrieveFile&param1=' + projectName + '&param2=' + projectName + '.project');
};

function populateNodes(){
	var nodes = project.allLeafNodes;
	var parent = document.getElementById('nodesTD');
	var old = document.getElementById('nodesUL');
	
	if(old){
		parent.removeChild(old);
	};
	
	var ul = createElement(document, 'ul', {id: 'nodesUL'});
	
	for(var v=0;v<nodes.length;v++){
		var li = createElement(document, 'li', {id: nodes[v].id, name: 'nodes', class: 'draggable'});
		li.innerHTML = nodes[v].title;
		ul.appendChild(li);
	};

	parent.appendChild(ul);
};

function populateSequences(){
	var nodes = project.allSequenceNodes;
	var parent = document.getElementById('sequencesTD');
	var old = document.getElementById('sequencesUL');
	
	if(old){
		parent.removeChild(old);
	};
	
	var ul = createElement(document, 'ul', {id: 'sequencesUL'});
	
	for(var v=0;v<nodes.length;v++){
		var sequenceName = nodes[v].id;
		var li = createElement(document, 'li', {id: 'li_' + sequenceName, name: 'sequences', class: 'draggable'});
		var sequenceTitle = document.createTextNode(sequenceName);
		var insideUL = createElement(document, 'ul', {id: sequenceName, name: 'sequenceContainer', class: 'container'});
		var placeholder = createElement(document, 'li', {id: sequenceName + '_LI', class: 'draggable'});
		
		insideUL.appendChild(placeholder);
		li.appendChild(sequenceTitle);
		li.appendChild(insideUL);
		ul.appendChild(li);
	};

	parent.appendChild(ul);
};
</script>
</head>

<body class="yui-skin-sam">

<div id="centeredDiv">

<div id="authorHeader">
	<h2>WISE 4 Authoring Tool &nbsp;<img src="../assets/images/favicon_panda.ico" alt="WISE Panada" border="0" /></h2>
	<table>
	  <tr>
	  	<td><input type="button" value="Open Project" onclick="openProject()"/></td>
	  	<td><input type="button" value="Create New Project" onclick="createNewProject()"/></td>
	  	<td><input type="button" value="Create New Sequence" onclick="createNewSequence()"/></td>
		<td><input type="button" value="Create New Node" onclick="createNewNode()" /></td>
		<td><input type="button" value="Delete Selected Node" onclick="" /></td>
		<td><input type="button" value="Indent Selected Node" onclick="" /></td>
		<td><input type="button" value="Outdent Selected Node" onclick="" /></td>
	  	<td><input type="button" value="Save Project" onclick="save()" /></td>
	  	<td><input type="button" value="Export Project" onclick="" /></td>
	  	<td><input type="button" value="Preview Project" onclick="preview()" /></td>
			 
			<!--  for posting the text for echo servlet -->
		<td style="display:hidden;"><form name="saveLocal" id='saveLocal' action="../../echo.html" method="POST">
			    <input type="hidden" name="name" id="form_filename" value="myData"/>
			    <input type="hidden" name="data" id="localData" value=""/>
				</form>
		</td>
	   </tr>
	 </table>
</div>

<table id="authoringTable">
	<tr><td id='currentProject'><h3>Current Project: </h3></td></tr>
	<tr>
	<tr>
		<td class="authorTableHeader" width="70%">Edit Project</td>
		<td class="authorTableHeader" width="30%">Preview</td>
	</tr>
	<tr>
		<td>
			<b>Please Note:</b> drag and drop for All Sequences and All Nodes is currently <b>NOT</b> implemented.<br>
			But you can edit the project file directly here when you are done creating sequences and nodes.<br>
			<input type="button" value="Edit Project File" onclick='editProjectFile()'/>
		</td>
	</tr>
	<tr>
		<td id="assignedcontainer">
			<table id="ddTable" width='100%'>
				<tr>
					<td id='projectTitle'>Project Structure</td>
					<td id='sequencesTitle'>All Sequences</td>
					<td id='nodesTitle'>All Nodes</td>
				</tr>
				<tr>
					<td id='projectTD'>
						<ul id='projectUL'></ul>
					</td>
					<td id='sequencesTD'>
						<ul id='sequencesUL'></ul>
					</td>
					<td id='nodesTD'>
						<ul id='nodesUL'></ul>
					</td>
				</tr>
			</table>
		</td>
		<td id="previewcontainer">
			<div >
				preview for selected node appears here
			</div>
		</td>
	</tr>
</table>
			
<div id="clearFloats" class="clearFloats" />

<div id="navigationInstructions">
	<p>Instructions:</p>
	<ol>
	<li>SELECT a node by clicking on its text.</li>
	<li>RENAME a node by clicking once on its text and typing changes.  Press Return key to save changes.</li>
	<li>REORDER a node by click-dragging on its blue border.</li>
	<li>EDIT a node for an item by double clicking.  A separate editor will launch.</li>
	</ol>	
</div> 


<script type="text/javascript">

function loadProject(filename) {
	thisFilename = filename;
	var callback =
	{
		success: function(o) { 
		  var xmlDocObj = new LoadXMLDocObj();
		  xmlDocObj.xmlDoc = o.responseXML;   
		  var xmlDocToParse = o.responseXML;
		  project = new Project(xmlDocToParse);
		  
		  project.xmlDoc = xmlDocToParse;
		  vle = new VLE();
		  vle.setProject(project);
		  var dfs = new DFS(project.rootNode);
		  vle.navigationLogic = new NavigationLogic(dfs);
		  vle.setConnection(new ConnectionManager());
		 
          displayProject(project);
	  },			
	  failure: function(o) { alert('failure');},
	  argument: ["a", "b", "c"]
	}
	var transaction = YAHOO.util.Connect.asyncRequest('GET', filename, callback, null);
}

/*
 * Displays all of the nodes in order, in the main window
 */
function displayProject(project) {
	document.getElementById("projectTD").innerHTML = getNavigationHtml(project.rootNode);
 	renderAuthoringYUI();
	
	populateSequences();
	populateNodes();
	//generateDD();
}

/*
 * Returns html of the specified node and of all its children
 */
function getNavigationHtml(node, floaters) {
	var htmlSoFar = "";
	if(node){
		if (node.children.length > 0) {
			// if it's a sequence node...
			htmlSoFar = "<ul id='" + node.id + "' class='container'>";
			//htmlSoFar += node.id + ", " + node.title;
			for(var x=0; x<node.children.length; x++) {
				htmlSoFar += getNavigationHtml(node.children[x]);
			}
			htmlSoFar += "</ul>";
		} else {
			// otherwise it's a leaf node
			var parentNode = node.parent;
			htmlSoFar = "<li id='" + node.id + "' class='draggable' ondblclick=\"author('"+ node.id + "');\" >";
			//htmlSoFar += "<textarea onfocus=\"nodeTitleOnFocus('"+node.id+"');\" onblur=\"nodeTitleOnBlur('"+node.id+"');\" id='"+ node.id +"'>"+ node.title +"</textarea>";
			htmlSoFar += "<textarea id='"+ node.id +"'>"+ node.title +"</textarea>";
			htmlSoFar += "</li>";
		}
	};
	
    return htmlSoFar;
}

function nodeTitleOnFocus(nodeId) {
	alert('on focus:' + nodeId);
}

function nodeTitleOnBlur(nodeId) {
	alert('on blur:' + nodeId);
}

/*
 * This function is called when the user wants to 
 * author the specified node.
 */
function author(nodeId) {
	//alert('author: ' + nodeId);
	var nodeToAuthor = project.getNodeById(nodeId);
	if (nodeToAuthor.filename != null) {
		nodeIdToAuthor = nodeId;
		var nodeToAuthor = project.getNodeById(nodeIdToAuthor); //is this needed? - the same thing only a few lines up
		filenameToAuthor = nodeToAuthor.filename;
		if (nodeToAuthor.type == "HtmlNode") {
			htmlPageName = 'author_htmlpage';
		} else if(nodeToAuthor.type == "FillinNode") {
			htmlPageName = 'author_fillin';
		} else if(nodeToAuthor.type == 'NoteNode' || nodeToAuthor.type == 'JournalEntryNode'){
			htmlPageName = 'author_openresponse';
		} else if(nodeToAuthor.type == 'MatchSequenceNode'){
			htmlPageName = 'author_matchsequence';
		} else if(nodeToAuthor.type == 'OutsideUrlNode'){
			htmlPageName = 'author_outsideurl';
		} else if(nodeToAuthor.type == 'MultipleChoiceNode'){
			htmlPageName = 'author_multiplechoice';
		} else if(nodeToAuthor.type == 'BrainstormNode'){
			htmlPageName = 'author_brainstorm';
		} else {
			alert('sorry, no authoring tool exists for this step yet');
			return;
		}
		popupAuthoringWindow('author_framed.html', nodeId);
	} else {
		alert('sorry, no authoring tool exists for this step yet');
	}
}

/*
 * Pops up window for authoring individual nodes. Param: url, url to open
 */
function popupAuthoringWindow(url, nodeId) {
	var child = window.open(url, nodeId, "toolbar=no,width=1240,height=800,menubar=no");
};

/*
 * Pops up window for authoring individual nodes. Param: url, url to open
 */
function popupPreviewWindow(url, name) {
	window.open(url, name, "toolbar=no,width=1024,height=768,menubar=no");
}

/*
 * called when the authoring window (popup) fires a loaded event.
 */
function authoringWindowLoaded(fun) {
	// we only care if the user has specified a node to author. if not, just ignore this event
	if (nodeIdToAuthor != null) {
	
		// fun is the function passed in from opened window to process the file
		var nodeToAuthor = project.rootNode.getNodeById(nodeIdToAuthor);
		fun(nodeToAuthor.filename, easyMode, htmlPageName, currentProjectName);
	} 
}


/*
 * called when the authoringFrame fires a loaded event.
 */
function authoringFrameLoaded() {
	//alert('authoringframeloaded called: ' + nodeIdToAuthor);
	// we only care if the user has specified a node to author. if not, just ignore this event
	if (nodeIdToAuthor != null) {
		//alert('authoringframeloaded, nodeIdToAuthor is set: ' + nodeIdToAuthor);
		// each authoring page has a load AuthoringFromFile function
		var nodeToAuthor = project.rootNode.getNodeById(nodeIdToAuthor);
		window.frames["authoringFrame"].loadAuthoringFromFile(nodeToAuthor.filename);
	} 
}
</script>

</div>  <!-- centerDiv -->

</body>

</html>