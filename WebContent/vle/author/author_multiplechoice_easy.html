<!-- @author: patrick lawler -->
<html>
<head>

<!-- Dependency --> 
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/yahoo/yahoo-min.js" ></script>

<!-- Event source file -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/event/event-min.js" ></script>

<!-- Sam Skin CSS -->
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.7.0/build/container/assets/skins/sam/container.css">

<!-- Dependencies -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/yahoo-dom-event/yahoo-dom-event.js"></script>

<!-- OPTIONAL: Animation (only required if using ContainerEffect) -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/animation/animation-min.js"></script>

<!-- OPTIONAL: Drag & Drop (only required if enabling Drag & Drop) -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/dragdrop/dragdrop-min.js"></script>

<!-- Source file -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/container/container-min.js"></script>

<!-- Connection manager -->
<script src="http://yui.yahooapis.com/2.7.0/build/connection/connection-min.js"></script>

<script type="text/javascript" src="../js/common/loadxmldoc.js"></script>
<script type="text/javascript" src="../js/common/helperfunctions.js"></script>
<script type="text/javascript" src="../js/node/Node.js"></script>
<script type="text/javascript" src="../js/node/MultipleChoiceNode.js"></script>

<script type="text/javascript" src="../js/node/multiplechoice/multiplechoicestate.js"></script>
<script type="text/javascript" src="../js/node/multiplechoice/mc.js"></script>

<script type="text/javascript">
var xmlPage;

/**
 * Removes previous elements and generates a new page with the
 * appropriate elements from this xmlPage
 */
function generatePage(){
	var parent = document.getElementById('dynamicParent');
	
	//wipe out old
	parent.removeChild(document.getElementById('dynamicPage'));
	
	//create new
	var pageDiv = createElement(document, 'div', {id:'dynamicPage'});
	var promptText = document.createTextNode('Edit prompt: ');
	var answerText = document.createTextNode('Edit/Create Answers and feedback here: ');
	var shuffleText = document.createTextNode('Shuffle Options');
	var feedbackText = document.createTextNode('Feedback Options');
	
	pageDiv.appendChild(shuffleText);
	pageDiv.appendChild(createBreak());
	pageDiv.appendChild(generateShuffle());
	pageDiv.appendChild(createBreak());
	pageDiv.appendChild(feedbackText);
	pageDiv.appendChild(createBreak());
	pageDiv.appendChild(generateFeedbackOptions());
	pageDiv.appendChild(createBreak());
	pageDiv.appendChild(promptText);
	pageDiv.appendChild(createBreak());
	pageDiv.appendChild(generatePrompt());
	pageDiv.appendChild(createBreak());
	pageDiv.appendChild(createBreak());
	pageDiv.appendChild(answerText);
	pageDiv.appendChild(generateAnswers());
	pageDiv.appendChild(createBreak());
	pageDiv.appendChild(createElement(document, 'input', {type: "button", id: "createNewButton", value: "Create New Choice", onclick: "createNewChoice()"}));
	pageDiv.appendChild(createElement(document, 'input', {type: "button", value: "Clear Correct Choice", onclick: "clearCorrectChoice()"}));
	
	parent.appendChild(pageDiv);
};

function generateShuffle(){
	var shuffleVal = xmlPage.getElementsByTagName('choiceInteraction')[0].getAttribute('shuffle');
	var shuffleDiv = createElement(document, 'div', {id: "shuffleDiv"});
	var shuffleTrue = createElement(document, 'input', {type: 'radio', name: 'shuffleOption', value: "true", onclick: "shuffleChange('true')"});
	var shuffleFalse = createElement(document, 'input', {type: 'radio', name: 'shuffleOption', value: "false", onclick: "shuffleChange('false')"});
	var trueText = createElement(document, 'label');
	trueText.innerHTML = 'shuffle choices';
	var falseText = createElement(document, 'label');
	falseText.innerHTML = 'do NOT shuffle choices';

	shuffleDiv.appendChild(shuffleTrue);
	shuffleDiv.appendChild(trueText);
	shuffleDiv.appendChild(createBreak());
	shuffleDiv.appendChild(shuffleFalse);
	shuffleDiv.appendChild(falseText);
	
	if(shuffleVal=='true'){
		shuffleTrue.checked = true;
	} else {
		shuffleFalse.checked = true;
	};
	return shuffleDiv;
};

function generateFeedbackOptions(){
	var feedbackVal = xmlPage.getElementsByTagName('choiceInteraction')[0].getAttribute('hasInlineFeedback');
	var feedbackOptionDiv = createElement(document, 'div', {id: 'feedbackOptionsDiv'});
	var feedbackOptionTrue = createElement(document, 'input', {type: 'radio', name: 'feedbackOption', value: "true", onclick: "feedbackOptionChange('true')"});
	var feedbackOptionFalse = createElement(document, 'input', {type: 'radio', name: 'feedbackOption', value: "false", onclick: "feedbackOptionChange('false')"});
	var trueText = createElement(document, 'label');
	trueText.innerHTML = 'has inline feedback';
	var falseText = createElement(document, 'label');
	falseText.innerHTML = 'does NOT have inline feedback';
	
	feedbackOptionDiv.appendChild(feedbackOptionTrue);
	feedbackOptionDiv.appendChild(trueText);
	feedbackOptionDiv.appendChild(createBreak());
	feedbackOptionDiv.appendChild(feedbackOptionFalse);
	feedbackOptionDiv.appendChild(falseText);
	
	if(feedbackVal=='true'){
		feedbackOptionTrue.checked = true;
	} else {
		feedbackOptionFalse.checked = true;
	};
	return feedbackOptionDiv;
};

/**
 * Creates and returns a prompt element that contains the prompt
 * for this xmlPage
 */
function generatePrompt(){
	var prompt = xmlPage.getElementsByTagName('prompt')[0].firstChild.nodeValue;
	var promptInput = createElement(document, 'textarea', {id: 'promptText', name: 'promptText', cols: '50', rows: '6', wrap: 'hard', onkeyup: "sourceUpdated()"});
	promptInput.value = prompt;
	return promptInput 
};

/**
 * Returns an element that contains the possible answers to the prompt for
 * this xmlPage with the appopriate feedback element
 */
function generateAnswers(){
	var answerElements = [];
	var answerTable = createElement(document, 'table', {id: 'answerTable'});
	answerTable.appendChild(generateAnswerTableHead());
	
	var answers = xmlPage.getElementsByTagName('simpleChoice');
	for(var h=0;h<answers.length;h++){
		var answerText = null;
		feedback = generateFeedback(answers[h], h);
		options = generateOptions(h, answers.length);
		for(var n=0;n<answers[h].childNodes.length;n++){
			if(answers[h].childNodes[n].nodeValue!=null){
				answerText = answers[h].childNodes[n].nodeValue;
			};
		};
		var newRow = createElement(document, 'tr', {name: "answerRow"});
		var answerTD = createElement(document, 'td');
		var answer = createElement(document, 'input', {type: 'text', name: "answerInput", value: answerText, onkeyup: "sourceUpdated()"});
		answerTD.appendChild(answer);
		
		newRow.appendChild(answerTD);
		newRow.appendChild(feedback);
		newRow.appendChild(options);
		answerTable.appendChild(newRow);
	};
	return answerTable;
};

/**
 * Returns a dynamically generated Header for the answer table
 */
function generateAnswerTableHead(){
	var tableHead = createElement(document, 'tr');
	var tableAnswer = createElement(document, 'td');
	var tableFeedback = createElement(document, 'td');
	var tableOption = createElement(document, 'td');
	tableAnswer.innerHTML = "ANSWER";
	tableFeedback.innerHTML = "FEEDBACK";
	tableOption.innerHTML = "OPTIONS";
	tableHead.appendChild(tableAnswer);
	tableHead.appendChild(tableFeedback);
	tableHead.appendChild(tableOption);
	return tableHead;
};

/**
 * Generates a text input element with associated feedback as value for a simpleChoice
 * xml when inline feedback exists and is specified for the entire MC question, otherwise
 * feedback is not available
 */
function generateFeedback(simpleChoice, index){
	var feedbackTD = createElement(document, 'td', {id: "feedbackTD_" + index});
	var feedback = simpleChoice.getElementsByTagName('feedbackInline');
	if(hasInlineFeedback()){
		if(feedback==null || feedback[0]==null){
			createNewFeedback(simpleChoice);
			feedback = simpleChoice.getElementsByTagName('feedbackInline');
		};
		var feedbackEl = createElement(document, 'input', {type: 'text', id: 'feedbackInput_' + index, name: "feedbackInput", onkeyup: "sourceUpdated()"});
		feedbackEl.value = feedback[0].firstChild.nodeValue;
	} else {
		var feedbackEl = createElement(document, 'div', {id: 'feedbackInput_' + index, name: 'feedbackInput_' + index});
	};
	feedbackTD.appendChild(feedbackEl);
	return feedbackTD;
};

/**
 * Generates and returns an option element that contains all the available options
 * for the given simpleChoice XML.
 */
function generateOptions(index, length){
	var options = createElement(document, 'td');
	var outStr;
	
	if(xmlPage.getElementsByTagName('correctResponse')[0].getAttribute('interpretation') == xmlPage.getElementsByTagName('simpleChoice')[index].getAttribute('identifier')){
		outStr = '<input CHECKED type="radio" name="correctRadio" value="' + index + '" onclick="correctChoiceChange(' + index + ')">This is the correct Choice';
	} else {
		outStr = '<input type="radio" name="correctRadio" value="' + index + '" onclick="correctChoiceChange(' + index + ')">This is the correct Choice';
	};
	
	outStr = outStr + '<br><a href="#" onclick="removeChoice(' + index + ')">Remove Choice</a>';
	
	if(index!=0){
		outStr = outStr + '<br><a href="#" onclick="moveUp(' + index + ')">move up</a>';
	};
	
	if(index!=(length-1)){
		outStr = outStr + '<br><a href="#" onclick="moveDown(' + index + ')">move down</a>';
	};
	
	options.innerHTML = outStr;
	return options;
};

/**
 * Removes previous button and creates input text field for feedback
 */
//function createFeedbackForChoice(index){
//	var feedbackParent = document.getElementById('feedbackTD_' + index);
//	feedbackParent.removeChild(document.getElementById('feedbackInput_' + index));
//	feedbackParent.appendChild(createElement(document, 'input', {type: 'text', id: 'feedbackInput_' + index}));
//};

/**
 * returns a <br> element
 */
function createBreak(){
	return createElement(document, 'br', null);
};

function createPrompt(){
	var prompt = xmlPage.createElement('prompt');
	var promptText = xmlPage.createTextNode(document.getElementById('promptText').value);
	prompt.appendChild(promptText);
	return prompt;
};

function createAnswer(parent){
	var answers = document.getElementsByName('answerRow');
	for(var d=0;d<answers.length;d++){
		var answer = answers[d].childNodes[0].childNodes[0];
		var feedback = answers[d].childNodes[1].childNodes[0];
		var simpleChoice = xmlPage.createElement('simpleChoice');
		var simpleText = xmlPage.createTextNode(answer.value);
		simpleChoice.setAttribute('fixed', "true");
		simpleChoice.setAttribute('identifier', "choice " + (d + 1));
		
		if(feedback!=null && feedback.getAttribute('type')=='text'){
			simpleChoice.appendChild(createFeedback(feedback, simpleChoice.getAttribute('identifier')));
		};
		
		if(answers[d].childNodes[2].childNodes[0].checked){
			xmlPage.getElementsByTagName('correctResponse')[0].setAttribute('interpretation', simpleChoice.getAttribute('identifier'));	
		};
		
		simpleChoice.appendChild(simpleText);
		parent.appendChild(simpleChoice);
	};
};

function createFeedback(feedback, identifier){
	var feedbackEl = xmlPage.createElement('feedbackInline');
	var feedbackText = xmlPage.createTextNode(feedback.value);
	feedbackEl.setAttribute('show', "true");
	feedbackEl.setAttribute('identifier', identifier);
	feedbackEl.appendChild(feedbackText);
	return feedbackEl;
};

function moveUp(index){
	var parent = xmlPage.getElementsByTagName('choiceInteraction')[0];
	var nodeToMove = parent.getElementsByTagName('simpleChoice')[index];
	var previousNode = nodeToMove.previousSibling;
	parent.removeChild(nodeToMove);
	parent.insertBefore(nodeToMove, previousNode);
	regenerateAnswers();
	sourceUpdated();
};

function moveDown(index){
	var parent = xmlPage.getElementsByTagName('choiceInteraction')[0];
	var nodeToMove = parent.getElementsByTagName('simpleChoice')[index];
	var nextNode = nodeToMove.nextSibling.nextSibling;
	parent.removeChild(nodeToMove);
	parent.insertBefore(nodeToMove, nextNode);
	regenerateAnswers();
	sourceUpdated();
};

function removeChoice(index){
	var parent = xmlPage.getElementsByTagName('choiceInteraction')[0];
	
	if(parent.getElementsByTagName('simpleChoice')[index].getAttribute('identifier')==xmlPage.getElementsByTagName('correctResponse')[0].getAttribute('interpretation')){
		clearCorrectChoice();
	};
	parent.removeChild(parent.getElementsByTagName('simpleChoice')[index]);
	regenerateAnswers();
	sourceUpdated();
};

function createNewChoice(){
	var parent = xmlPage.getElementsByTagName('choiceInteraction')[0];
	var numOfAnswers = xmlPage.getElementsByTagName('simpleChoice').length;
	var simpleChoice = xmlPage.createElement('simpleChoice');
	var simpleText = xmlPage.createTextNode("");
	
	simpleChoice.setAttribute('fixed', "true");
	simpleChoice.setAttribute('identifier', "choice " + (numOfAnswers + 1));
	simpleChoice.appendChild(simpleText);
	createNewFeedback(simpleChoice);
	
	parent.appendChild(simpleChoice);
	regenerateAnswers();
	sourceUpdated();
};

function createNewFeedback(simpleChoice){
	var feedback = xmlPage.createElement('feedbackInline');
	var feedbackText = xmlPage.createTextNode('Enter your feedback here');
	feedback.setAttribute('showHide', 'show');
	feedback.setAttribute('identifier', simpleChoice.getAttribute('identifier'));
	feedback.appendChild(feedbackText);
	simpleChoice.appendChild(feedback);
};

function regenerateAnswers(){
	var parent = document.getElementById('dynamicPage');
	parent.removeChild(document.getElementById('answerTable'));
	var answer = generateAnswers();
	var nextNode = document.getElementById('createNewButton');
	parent.insertBefore(answer, nextNode);
};

function shuffleChange(val){
	xmlPage.getElementsByTagName('choiceInteraction')[0].setAttribute('shuffle', val);
	sourceUpdated();
};

function correctChoiceChange(index){
	xmlPage.getElementsByTagName('correctResponse')[0].setAttribute('interpretation', xmlPage.getElementsByTagName('simpleChoice')[index].getAttribute('identifier'));
	sourceUpdated();
};

function save() {
	if(validate()){
		  if(confirm("Saving locally requires a file download. If you do not wish to do this, click CANCEL now. Otherwise, click OK.")){
			  var htmlString;
			  
			if(window.ActiveXObject) {
				htmlString = xmlPage.xml;
			} else {
				htmlString = (new XMLSerializer()).serializeToString(xmlPage);
			}
			  
		      document.getElementById('localData').value = htmlString;
		      if (thisFilename != null) {
		      	document.getElementById('form_filename').value = thisFilename;
		      }
		      document.getElementById('saveLocal').submit();
		   };
	};
};

/**
 * Removes check from all correct choice radio buttons and updates
 * xmlPage so that there is no correct choice
 */
function clearCorrectChoice(){
	var radios = document.getElementsByName('correctRadio');
	for(var p=0;p<radios.length;p++){
		radios[p].checked = false;
	};
	xmlPage.getElementsByTagName('correctResponse')[0].setAttribute('interpretation', '');
};

/**
 * Returns true iff all of the choice fields are not blank, 
 * otherwise, returns false
 */
function validate(){
	var choices = document.getElementsByName('answerInput');
	var empty = false;
	
	for(var c=0;c<choices.length;c++){
		if(choices[c].value==null || choices[c].value==""){
			empty = true;
		};
	};
	
	if(empty){
		alert("No choice fields are allowed to be empty or null. Exiting...");
		return false;
	};
	return true;
};

function hasInlineFeedback(){
	var feedback = xmlPage.getElementsByTagName('choiceInteraction')[0].getAttribute('hasInlineFeedback');
	if(feedback && feedback=='true'){
		return true;
	} else {
		return false;
	};
};

function feedbackOptionChange(val){
	xmlPage.getElementsByTagName(xmlPage.getElementsByTagName('choiceInteraction')[0].setAttribute('hasInlineFeedback', val));
	regenerateAnswers();
	sourceUpdated();
};

/**
 * Load the authoring view from the specified filename
 * filename points to a plain old file.
 */
function loadAuthoringFromFile(filename) {
	thisFilename = filename
	var callback =
	{
	  success: function(o) { 
	  var xmlDocToParse = o.responseXML;
		
		/**
		 * sets local xml and then generates the left panel
		 * of this page dynamically
		 */
		xmlPage = o.responseXML;
		generatePage();
			
		//retrieve the xmlString from the mcObj
		var xmlString = "";
		if(window.ActiveXObject) {
			xmlString = xmlDocToParse.xml;
		} else {
			xmlString = (new XMLSerializer()).serializeToString(xmlDocToParse);
		}

		window.frames["previewFrame"].renderMCFromString(xmlString);

		  },
		  failure: function(o) { alert('failure');},
		  argument: ["a", "b", "c"]
	}

	// fetch the file
	var transaction = YAHOO.util.Connect.asyncRequest('GET', filename, callback, null);
}

/*
 * Called when 'keyup' event is received on sourceTextArea on this page.
 * gets the text in the textarea and re-renders the previewFrame
 */
function sourceUpdated() {
	//retrieve the authored text
	var parent = xmlPage.getElementsByTagName('choiceInteraction')[0];
	while(parent.firstChild){  //removes all children (prompt, simpleResponse) from choiceInteraction
		parent.removeChild(parent.firstChild);
	};
	
	parent.appendChild(createPrompt());
	createAnswer(parent);
	
	var xmlString;
	if(window.ActiveXObject) {
		xmlString = xmlPage.xml;
	} else {
		xmlString = (new XMLSerializer()).serializeToString(xmlPage);
	}

	window.frames["previewFrame"].renderMCFromString(xmlString);
}

function loaded(){
	if(window.opener){
		window.opener.authoringWindowLoaded(loadAuthoringFromFile);
	};
};
</script>
</head>
<body onload="loaded()">
<input type="button" value="save" onclick="save()" />
<table border='1' bgcolor='white' style='width:100%;height:100%'>
	<tr>
   		<td width='50%' id="dynamicParent"><div id="dynamicPage"></div></td>
   		<td width='50%'><iframe id='previewFrame' width='100%' height='100%' name='previewFrame' src='multiplechoice_plain.html'></iframe></td>
	</tr>
</table>
<!--  for posting the text for echo servlet -->
<form name="saveLocal" id='saveLocal' action="../../echo.html" method="POST">
    <input type="hidden" name="name" id="form_filename" value="myData"/>
    <input type="hidden" name="data" id="localData" value=""/>
</form>
</body>
</html>