<!--
 * Copyright (c) 2009 Regents of the University of California (Regents). Created
 * by TELS, Graduate School of Education, University of California at Berkeley.
 *
 * This software is distributed under the GNU Lesser General Public License, v2.
 *
 * Permission is hereby granted, without written agreement and without license
 * or royalty fees, to use, copy, modify, and distribute this software and its
 * documentation for any purpose, provided that the above copyright notice and
 * the following two paragraphs appear in all copies of this software.
 *
 * REGENTS SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE. THE SOFTWAREAND ACCOMPANYING DOCUMENTATION, IF ANY, PROVIDED
 * HEREUNDER IS PROVIDED "AS IS". REGENTS HAS NO OBLIGATION TO PROVIDE
 * MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
 *
 * IN NO EVENT SHALL REGENTS BE LIABLE TO ANY PARTY FOR DIRECT, INDIRECT,
 * SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES, INCLUDING LOST PROFITS,
 * ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN IF
 * REGENTS HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * @author: patrick lawler
 -->
<html>
<head>

<!-- Dependency --> 
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/yahoo/yahoo-min.js" ></script>

<!-- Event source file -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/event/event-min.js" ></script>

<!-- Sam Skin CSS -->
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.7.0/build/container/assets/skins/sam/container.css">

<!-- AUTHOR CSS -->
<link rel="stylesheet" type="text/css" href="../css/authoring/authoring.css">

<!-- Dependencies -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/yahoo-dom-event/yahoo-dom-event.js"></script>

<!-- OPTIONAL: Animation (only required if using ContainerEffect) -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/animation/animation-min.js"></script>

<!-- OPTIONAL: Drag & Drop (only required if enabling Drag & Drop) -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/dragdrop/dragdrop-min.js"></script>

<!-- Source file -->
<script type="text/javascript" src="http://yui.yahooapis.com/2.7.0/build/container/container-min.js"></script>

<!-- Connection manager -->
<script src="http://yui.yahooapis.com/2.7.0/build/connection/connection-min.js"></script>

<script src="http://yui.yahooapis.com/3.0.0pr2/build/yui/yui-min.js" type="text/javascript"></script>

<script type="text/javascript" src="../js/common/loadxmldoc.js"></script>
<script type="text/javascript" src="../js/common/helperfunctions.js"></script>
<script type="text/javascript" src="../js/node/Node.js"></script>
<script type="text/javascript" src="../js/node/GlueNode.js"></script>
<script type="text/javascript" src="../js/authoring/author_glue.js"></script>

<script type="text/javascript" src="../js/node/common/js/loadxmldoc.js"></script>

<script type="text/javascript">
var xmlPage;
var saved = true;
var project = window.parent.project;
var allowedGlue = new Array('MultipleChoiceNode', 'FillinNode');

function generatePage(){
	var parent = document.getElementById('dynamicParent');
	
	//wipe out old elements
	parent.removeChild(document.getElementById('dynamicPage'));
	
	//create new elements
	var pageDiv = createElement(document, 'div', {id:'dynamicPage'});
	parent.appendChild(pageDiv);
	
	var promptDiv = createElement(document, 'div', {id:'promptDiv'});
	var promptText = document.createTextNode('Edit Prompt');
	var promptInput = createElement(document, 'textarea', {id:'promptInput', cols: '75', rows: '18', wrap: 'soft', onkeyup: 'updatePrompt()'});
	
	pageDiv.appendChild(promptDiv);
	promptDiv.appendChild(promptText);
	promptDiv.appendChild(createBreak());
	promptDiv.appendChild(promptInput);
	
	promptInput.value = getPrompt();
	
	var ddTable = createElement(document, 'table', {id:'ddGlueTable', width:'100%'});
	var ddHeaderRow = createElement(document, 'tr', {id:'ddHeaderRow'});
	var ddAttachedHeadTD = createElement(document, 'td', {id:'ddAttachedHeadTD', width:'40%'});
	var ddNodesHeadTD = createElement(document, 'td', {id:'ddNodesHeadTD', width:'40%'});
	var ddTrashHeadTD = createElement(document, 'td', {id:'ddTrashHeadTD', width:'20%'});
	
	pageDiv.appendChild(ddTable);
	ddTable.appendChild(ddHeaderRow);
	ddHeaderRow.appendChild(ddAttachedHeadTD);
	ddHeaderRow.appendChild(ddNodesHeadTD);
	ddHeaderRow.appendChild(ddTrashHeadTD);
	
	ddAttachedHeadTD.innerHTML = "Add/Remove/Arrange Nodes";
	ddNodesHeadTD.innerHTML = "All Allowable Nodes";
	ddTrashHeadTD.innerHTML = "Trash Can";
	
	var ddRow = createElement(document, 'tr', {id:'ddRow'});
	var ddAttachedTD = createElement(document, 'td', {id:'ddAttachedTD'});
	var ddNodesTD = createElement(document, 'td', {id:'ddNodesTD'});
	var ddTrashTD = createElement(document, 'td', {id:'ddTrashTD'});
	
	ddTable.appendChild(ddRow);
	ddRow.appendChild(ddAttachedTD);
	ddRow.appendChild(ddNodesTD);
	ddRow.appendChild(ddTrashTD);
	
	generateAttached();
	generateNodes();
	generateTrash();
	generateGlueDD();
};

function generateAttached(){
	var parent = document.getElementById('ddAttachedTD');
	
	//remove old
	while(parent.firstChild){
		parent.removeChild(parent.firstChild);
	};
	
	//create new
	var attachedUL = createElement(document, 'ul', {id:'attachedUL', class:'container'});
	var attachedText = document.createTextNode('Attached Nodes:');
	var placeholder = createElement(document, 'li', {id:'placeholder'});
	var children = getChildren();
	
	parent.appendChild(attachedUL);
	attachedUL.appendChild(attachedText);
	attachedUL.appendChild(createBreak());
	attachedUL.appendChild(placeholder);
	
	for(var x=0;x<children.length;x++){
		var childId = children[x].getAttribute('ref');
		var child = createElement(document, 'li', {id:'attached_' + childId, name:'attached', class: 'draggable'});
		var childTitle = document.createTextNode(project.getNodeById(childId).title);
		attachedUL.appendChild(child);
		child.appendChild(childTitle);
	};
};

function generateNodes(){
	var parent = document.getElementById('ddNodesTD');
	
	//remove old
	while(parent.firstChild){
		parent.removeChild(parent.firstChild);
	};
	
	//create new
	var nodesUL = createElement(document, 'ul', {id:'nodesUL'});
	var placeholder = createElement(document, 'li', {id:'placeholder'});
	var nodes = project.allLeafNodes;
	
	parent.appendChild(nodesUL);
	nodesUL.appendChild(placeholder);
	
	for(var y=0;y<nodes.length;y++){
		if(allowedGlue.indexOf(nodes[y].type)>-1){
			var nodeId = nodes[y].id;
			var node = createElement(document, 'li', {id:'node_' + nodeId, name:'ddNodes', class:'draggable'});
			var nodeTitle = document.createTextNode(nodes[y].title);
			
			nodesUL.appendChild(node);
			node.appendChild(nodeTitle);
		};
	};
};

function generateTrash(){
	var parent = document.getElementById('ddTrashTD');
	
	var old = document.getElementById('trashDiv');
	
	if(old){
		parent.removeChild(old);
	};
	
	var trash = createElement(document, 'div', {id:'trashDiv', class:'trash'});
	
	parent.appendChild(trash);
	trash.innerHTML = 'Trash Bin';
};

function getChildren(){
	return xmlPage.getElementsByTagName('node-ref');
};

function getPrompt(){
	var promptEl = xmlPage.getElementsByTagName('prompt');
	if(promptEl[0].firstChild){
		return promptEl[0].firstChild.nodeValue;
	} else {
		return "";
	};
};

function updatePrompt(){
	var val = document.getElementById('promptInput').value;
	var promptEl = xmlPage.getElementsByTagName('prompt')[0];
	if(promptEl.firstChild){
		promptEl.firstChild.nodeValue = val;
	} else {
		promptEl.appendChild(xmlPage.createTextNode(val));
	};
	
	updatePreview();
};

function save(){
	var htmlString;
	
	if(window.ActiveXObject) {
		htmlString = xmlPage.xml;
	} else {
		htmlString = (new XMLSerializer()).serializeToString(xmlPage);
	};
	
	var callback = {
		success: function(o){
			saved = true;
			if(o.responseText!='success'){
				alert('Failed save to server');
			};
		},
		failure: function(o){alert('Unable to save file to server');},
		scope:this
	};
	
	YAHOO.util.Connect.asyncRequest('POST', '../../filemanager.html', callback, 'command=updateFile&param1=' + parent.projectName + '&param2=' + parent.filename + '&param3=' + encodeURIComponent(htmlString));
};

function getSaved(){
	return saved;
};

/**
 * Load the authoring view from the specified filename
 * filename points to a plain old file.
 */
function loadAuthoringFromFile(filename, projectName) {
	var callback =
	{
	  success: function(o) { 
	  var xmlDocToParse = o.responseXML;

		  /***						***|
		   * Extra work needed for IE *|
		   ***						***/
		  if(window.ActiveXObject){
		  	var ieXML = new ActiveXObject("Microsoft.XMLDOM");
		  	ieXML.async = "false";
		  	ieXML.loadXML(o.responseText);
		  	xmlDocToParse = ieXML;
		  };
		  /***						***|
		   * End extra work for IE	  *|
		   ***						***/
	  
		/**
		 * sets local xml and then generates the left panel
		 * of this page dynamically
		 */
		xmlPage = xmlDocToParse;
		generatePage();
	
		//retrieve the xmlString
		var xmlString = "";
		if(window.ActiveXObject) {
			xmlString = xmlDocToParse.xml;
		} else {
			xmlString = (new XMLSerializer()).serializeToString(xmlDocToParse);
		}
		
		window.frames["previewFrame"].loadXMLString(xmlString);

	  },
		  failure: function(o) { alert('failure');},
		  scope: this
	}
	
	YAHOO.util.Connect.asyncRequest('POST', '../../filemanager.html', callback, 'command=retrieveFile&param1=' + projectName + '&param2=' + filename);
}

function updatePreview(){
	saved = false;
	var xmlString;
	if(window.ActiveXObject) {
		xmlString = xmlPage.xml;
	} else {
		xmlString = (new XMLSerializer()).serializeToString(xmlPage);
	};
	
	window.frames["previewFrame"].loadXMLString(xmlString);
};

function loaded(){
	if(window.parent){
		loadAuthoringFromFile(window.parent.filename, window.parent.projectName);
		window.parent.childSave = save;
		window.parent.getSaved = getSaved;
	};
};

/**
 * returns a <br> element
 */
function createBreak(){
	return createElement(document, 'br', null);
};

/**
 * returns a space
 */
function createSpace(){
	return document.createTextNode(' ');
};

</script>
</head>
<body onload="loaded()">
<table border='1' bgcolor='white' style='width:100%;height:100%'>
	<tr>
		<td width='50%' id="dynamicParent"><div id="dynamicPage"></div></td>
   		<td width='50%'><iframe id='previewFrame' width='100%' height='100%' name='previewFrame' src='../js/node/glue/glue.html'></iframe></td>
	</tr>
</table>
</body>
</html>