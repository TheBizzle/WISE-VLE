<html>
<head>
<script type='text/javascript' src='data.js'></script>
<script type='text/javascript' src='lz77.js'></script>
<script>
var lz77 = new LZ77();

/**
 * Populate the drop down with the workgroup ids and display the work from
 * the first workgroup id
 */
function loadStudentData() {
	if(typeof data == 'undefined') {
		//we were unable to access the data in the data.js file
		document.getElementById('metaDataDiv').innerHTML += 'Error: Unable to load data<br>';
		return;
	}

	//display the project, run, and step information
	document.getElementById('metaDataDiv').innerHTML += 'Project Name: ' + data.projectName + '<br>';
	document.getElementById('metaDataDiv').innerHTML += 'Project Id: ' + data.projectId + '<br>';
	document.getElementById('metaDataDiv').innerHTML += 'Run Id: ' + data.runId + '<br>';
	document.getElementById('metaDataDiv').innerHTML += 'Step Name: ' + data.stepName + '<br>';
	document.getElementById('metaDataDiv').innerHTML += '<hr>';

	//add the drop down to select the workgroup id
	document.getElementById('navigationDiv').innerHTML += 'Workgroup Id: <select id="workgroupIdSelect" onchange="displayStudentData()"></select>';
	document.getElementById('navigationDiv').innerHTML += '&nbsp';
	
	//add the previous button
	document.getElementById('navigationDiv').innerHTML += '<input type="button" value="Previous" onclick="displayPrevious()"/>';
	document.getElementById('navigationDiv').innerHTML += '&nbsp';
	
	//add the next button
	document.getElementById('navigationDiv').innerHTML += '<input type="button" value="Next" onclick="displayNext()"/>';

	//get the array of student data
	var studentDataArray = data.studentDataArray;

	//loop through the array of student data
	for(var x=0; x<studentDataArray.length; x++) {
		//get a student data object
		var tempStudentDataObj = studentDataArray[x];
		
		if(tempStudentDataObj != null) {
			//get the workgroup id
			var tempWorkgroupId = tempStudentDataObj.workgroupId;
			
			//create an option element
			var tempOption = document.createElement('option');
			tempOption.value = tempWorkgroupId;
			tempOption.text = tempWorkgroupId;
			
			//put the option element into the drop down
			document.getElementById('workgroupIdSelect').appendChild(tempOption);
		}
	}
	
	//display the first workgroup id since the first workgroup id will be the one initially selected
	displayStudentData();
}

/**
 * Get the student data object for the given workgroup id
 * @param workgroupId the workgroup id to retrieve
 */
function getStudentDataByWorkgroupId(workgroupId) {
	//get the array of student data
	var studentDataArray = data.studentDataArray;

	//loop through the array of student data
	for(var x=0; x<studentDataArray.length; x++) {
		//get a student data object
		var tempStudentDataObj = studentDataArray[x];
		
		if(tempStudentDataObj != null) {
			//get the workgroup id
			var tempWorkgroupId = tempStudentDataObj.workgroupId;
			
			if(workgroupId == tempWorkgroupId) {
				//we have found the workgroup id we want
				return tempStudentDataObj;
			}
		}
	}
	
	//we did not find the workgroup id
	return null;
}

/**
 * Display the previous workgroup id
 */
function displayPrevious() {
	//get the selected index in the drop down
	var selectedIndex = document.getElementById('workgroupIdSelect').selectedIndex;
	
	//get all the options in the drop down
	var options = document.getElementById('workgroupIdSelect').options;
	
	//get the new index we want to display
	var newSelectedIndex = selectedIndex - 1;
	
	if(newSelectedIndex < 0) {
		//there is no previous workgroup id
		alert('There is no previous Workgroup Id. You are on the first one.');
	} else {
		//change the drop down to the previous option
		document.getElementById('workgroupIdSelect').selectedIndex = newSelectedIndex;
		
		//display the student data for the workgroup id that is now selected in the drop down
		displayStudentData();
	}
}

/**
 * Display the next workgroup id
 */
function displayNext() {
	//get the selected index in the drop down
	var selectedIndex = document.getElementById('workgroupIdSelect').selectedIndex;
	
	//get all the options in the drop down
	var options = document.getElementById('workgroupIdSelect').options;
	
	//get the new index we want to display
	var newSelectedIndex = selectedIndex + 1;
	
	if(newSelectedIndex > options.length - 1) {
		//there is no next workgroup id
		alert('There is no next Workgroup Id. You are on the last one.');
	} else {
		//change the drop down to the next option
		document.getElementById('workgroupIdSelect').selectedIndex = newSelectedIndex;
		
		//display the student data for the workgroup id that is now selected in the drop down
		displayStudentData();
	}
}

/**
 * Display the student data for the workgroup id that is currently selected
 * in the drop down
 */
function displayStudentData() {
	//get the selected index in the drop down
	var selectedIndex = document.getElementById('workgroupIdSelect').selectedIndex;
	
	//get all the options in the drop down
	var options = document.getElementById('workgroupIdSelect').options;
	
	//get the selected workgroup id
	var workgroupId = options[selectedIndex].value;
	
	//get the student data object for the workgroup id
	var tempStudentDataObj = getStudentDataByWorkgroupId(workgroupId);
	
	//clear out the student data div to wipe out the previous student data we were displaying
	document.getElementById('studentDataDiv').innerHTML = '';
	
	//display the step work id
	document.getElementById('studentDataDiv').innerHTML += 'Step Work Id: ' + tempStudentDataObj.stepWorkId + '<br>';

	//get the student data
	var studentData = tempStudentDataObj.studentData;
	var svgString = '';

	if(studentData != null && studentData != '') {
		//unescape the student data
		studentData = unescape(studentData);
		
		//decompress the student data
		svgString = lz77.decompress(studentData);

		//add the xmlns:xlink if it does not exist
		if(svgString.indexOf('xmlns:xlink="http://www.w3.org/1999/xlink"') == -1) {
			//the xmlns:xlink does not exist so we will inject it into the svg tag
			
			//create the pattern to match the opening svg tag
			var svgOpenTagPattern = /<svg .*?>/;
			
			//try to find the pattern in the svg string
			var svgOpenTagMatch = svgOpenTagPattern.exec(svgString);
			
			//get the first match
			var svgOpenTagMatch0 = svgOpenTagMatch[0];
			
			if(svgOpenTagMatch0 != null) {
				//inject the xmlns:xlink into the svg opening tag
				var newSVGOpenTag = svgOpenTagMatch0.replace('>', ' xmlns:xlink="http://www.w3.org/1999/xlink">');
				
				//replace the svg opening tag in the svg string
				svgString = svgString.replace(svgOpenTagMatch0, newSVGOpenTag);
			}
		}

		//replace all instances of imagexlink with image xlink
		svgString = svgString.replace(/imagexlink/g, 'image xlink');

		//add the </image> closing tags if they are not present
		
		//create the pattern to match opening image tags with an optional closing tag
		var pattern = /(<image .*?>)(<\/image>)?/g;
		
		//find the first match
		var match = pattern.exec(svgString);

		//loop until we have found all the image tags
		while(match != null) {
			//get the whole match
			var wholeMatch = match[0];
			
			//get the image opening tag
			var match1 = match[1];
			
			//get the image closing tag if it exists
			var match2 = match[2];

			if(match2 == null) {
				//the image closing tag does not exist so we will insert it
				svgString = svgString.replace(wholeMatch, wholeMatch + "</image>");
			}

			//find the next match
			match = pattern.exec(svgString);
		}

	}

	if(svgString == '') {
		//this student didn't do any work
		svgString = 'No Student Work';
	} else {
		//add a new line before displaying the work
		svgString = '<br>' + svgString;
	}

	//display the student work
	document.getElementById('studentDataDiv').innerHTML += 'Student Data: ' + svgString + '<br>';
	document.getElementById('studentDataDiv').innerHTML += '<br>';
}

</script>
</head>
<body onload='loadStudentData()'>
<div id='metaDataDiv'></div>
<div id='navigationDiv'></div>
<div id='studentDataDiv'></div>
</body>
</html>
